<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJHB CRM Contable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --color-negro: #121212;
            --color-platino: #E5E4E2;
            --color-dorado: #FFD700;
            --color-texto-claro: #FFFFFF;
            --color-texto-oscuro: #333333;
            --color-fondo: #1A1A1A;
            --color-error: #FF5252;
            --color-exito: #4CAF50;
            --color-card: #2A2A2A;
            --gradient-dark: linear-gradient(135deg, #1A1A1A 0%, #121212 100%);
            --shadow-soft: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-strong: 0 8px 16px rgba(0, 0, 0, 0.3);
            --glow-dorado: 0 0 20px rgba(255, 215, 0, 0.4);
            --color-accent: #FFB300;
            --color-hover: #FFC107;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { 
            background: var(--gradient-dark); 
            color: var(--color-texto-claro); 
            min-height: 100vh; 
            position: relative;
            overflow-x: hidden;
        }
        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: introFadeOut 1s ease-out 5s forwards;
            overflow: hidden;
            transition: opacity 1s ease-out;
            will-change: opacity;
        }
        @keyframes introFadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        .intro-vignette {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.8) 100%);
            pointer-events: none;
            z-index: 5;
        }
        .intro-cinematic-bars {
            position: absolute;
            width: 100%;
            height: 12%;
            background: linear-gradient(to bottom, #000 0%, #0a0a0a 50%, #000 100%);
            z-index: 10;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
        }
        .intro-cinematic-bars.top {
            top: 0;
        }
        .intro-cinematic-bars.bottom {
            bottom: 0;
        }
        .intro-bg-stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(3px 3px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(2px 2px at 80% 10%, white, transparent),
                radial-gradient(3px 3px at 90% 60%, white, transparent),
                radial-gradient(1px 1px at 33% 80%, white, transparent),
                radial-gradient(2px 2px at 15% 60%, white, transparent),
                radial-gradient(1px 1px at 70% 40%, white, transparent),
                radial-gradient(2px 2px at 40% 20%, white, transparent);
            background-size: 200% 200%;
            background-position: 0% 0%;
            animation: starsMove 120s linear infinite, starsTwinkle 3s ease-in-out infinite;
            opacity: 0;
            animation-delay: 0s, 1.5s;
            animation-fill-mode: forwards, none;
        }
        @keyframes starsMove {
            0% { 
                background-position: 0% 0%;
                opacity: 0;
            }
            10% {
                opacity: 0.5;
            }
            100% { 
                background-position: 100% 100%;
                opacity: 0.5;
            }
        }
        @keyframes starsTwinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
        .intro-nebula {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 50% 50%, rgba(255, 215, 0, 0.15) 0%, transparent 50%);
            opacity: 0;
            animation: nebulaAppear 1s ease-out 0.3s forwards;
            filter: blur(40px);
        }
        @keyframes nebulaAppear {
            to { opacity: 1; }
        }
        .intro-light-beam {
            position: absolute;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(255, 215, 0, 0.8) 50%, 
                transparent 100%);
            opacity: 0;
            animation: lightBeam 0.3s ease-out 0.7s;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        .intro-light-beam:nth-child(1) { left: 30%; animation-delay: 0.7s; }
        .intro-light-beam:nth-child(2) { left: 50%; animation-delay: 0.75s; }
        .intro-light-beam:nth-child(3) { left: 70%; animation-delay: 0.8s; }
        @keyframes lightBeam {
            0%, 100% { opacity: 0; transform: scaleY(0); }
            50% { opacity: 1; transform: scaleY(1); }
        }
        .intro-content {
            text-align: center;
            position: relative;
            z-index: 2;
        }
        .intro-logo-container {
            position: relative;
            display: inline-block;
        }
        .intro-logo {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-bottom: 2rem;
            perspective: 2000px;
            position: relative;
        }
        .intro-letter {
            font-size: 13rem;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 
                0 0 20px rgba(255, 255, 255, 1),
                0 0 40px rgba(255, 215, 0, 1),
                0 0 80px rgba(255, 215, 0, 0.8),
                0 10px 30px rgba(0, 0, 0, 1);
            opacity: 0;
            transform: scale(0);
            animation: letterCinematic 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            will-change: transform, opacity;
        }
        .intro-letter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, rgba(255, 215, 0, 0.2) 30%, transparent 70%);
            transform: translate(-50%, -50%);
            z-index: -2;
            opacity: 0;
            animation: letterExplosion 0.8s ease-out forwards;
            border-radius: 50%;
            filter: blur(20px);
        }
        .intro-letter:nth-child(1) { 
            animation-delay: 0.5s;
        }
        .intro-letter:nth-child(1)::after { animation-delay: 0.5s; }
        .intro-letter:nth-child(2) { 
            animation-delay: 0.65s;
        }
        .intro-letter:nth-child(2)::after { animation-delay: 0.65s; }
        .intro-letter:nth-child(3) { 
            animation-delay: 0.8s;
        }
        .intro-letter:nth-child(3)::after { animation-delay: 0.8s; }
        .intro-letter:nth-child(4) { 
            animation-delay: 0.95s;
        }
        .intro-letter:nth-child(4)::after { animation-delay: 0.95s; }
        @keyframes letterCinematic {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            60% {
                opacity: 1;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes letterAura {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }
        @keyframes letterExplosion {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(2.5);
            }
        }
        .intro-subtitle {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, 
                #00ffff 0%, 
                #ff00ff 50%, 
                #ffff00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1.5rem;
            text-transform: uppercase;
            opacity: 0;
            transform: translateY(30px) scale(0.8);
            animation: subtitleReveal 1s ease-out 1.5s forwards;
            filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.8));
            position: relative;
        }
        .intro-subtitle::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, #ff00ff, #ffff00, transparent);
            opacity: 0;
            animation: lineExpand 1s ease-out 3s forwards;
        }
        .intro-subtitle::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffff00, #ff00ff, #00ffff, transparent);
            opacity: 0;
            animation: lineExpand 1s ease-out 3.2s forwards;
        }
        @keyframes subtitleReveal {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        @keyframes lineExpand {
            0% {
                opacity: 0;
                transform: scaleX(0);
            }
            100% {
                opacity: 1;
                transform: scaleX(1);
            }
        }
        .intro-credit {
            position: absolute;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 0.4rem;
            text-transform: uppercase;
            opacity: 0;
            animation: creditFade 1s ease-out 3.5s forwards, creditPulse 2s ease-in-out 4.5s infinite;
            z-index: 11;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8),
                         0 0 30px rgba(255, 215, 0, 0.4);
        }
        @keyframes creditFade {
            to {
                opacity: 1;
            }
        }
        @keyframes creditPulse {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }
        .intro-logo-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 150%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.15) 40%, transparent 70%);
            pointer-events: none;
            border-radius: 50%;
            filter: blur(60px);
            z-index: -1;
        }
        .intro-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .intro-particle {
            position: absolute;
            background: var(--color-dorado);
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        .intro-glow {
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: megaGlow 3s ease-in-out infinite;
            filter: blur(40px);
        }
        @keyframes megaGlow {
            0%, 100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.3;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 0.6;
            }
        }
        .intro-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ringExpand 2.5s ease-out 0.8s forwards;
        }
        .intro-ring::before,
        .intro-ring::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid rgba(255, 215, 0, 0.6);
            animation: ringPulse 2.5s ease-out 0.8s forwards;
        }
        .intro-ring::after {
            animation-delay: 1s;
        }
        @keyframes ringExpand {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(3.5);
                opacity: 0;
            }
        }
        @keyframes ringPulse {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
        .intro-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 215, 0, 0.6) 30%,
                transparent 70%);
            opacity: 0;
            animation: megaFlash 0.6s ease-out 0.8s;
        }
        @keyframes megaFlash {
            0% { 
                opacity: 0;
                transform: scale(0.5);
            }
            30% { 
                opacity: 1;
                transform: scale(1.2);
            }
            100% { 
                opacity: 0;
                transform: scale(2);
            }
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(229, 228, 226, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 215, 0, 0.02) 0%, transparent 50%);
            animation: backgroundPulse 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes backgroundPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        .particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: var(--color-dorado);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            animation: float 20s infinite;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100vh) translateX(100px) scale(1);
                opacity: 0;
            }
        }
        .grid-line {
            position: fixed;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            pointer-events: none;
            z-index: 1;
        }
        
        .grid-line-h {
            width: 100%;
            height: 1px;
            animation: slideHorizontal 8s linear infinite;
        }
        
        .grid-line-v {
            width: 1px;
            height: 100%;
            animation: slideVertical 8s linear infinite;
        }
        
        @keyframes slideHorizontal {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes slideVertical {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .navbar, .main-container { position: relative; z-index: 10; }
        .navbar { background-color: var(--color-negro); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-strong); flex-wrap: wrap; }
        .logo-container { display: flex; flex-direction: column; align-items: center; }
        .logo-text { display: flex; gap: 0.25rem; margin-bottom: 0.25rem; }
        .logo-letter { color: var(--color-dorado); font-size: 2.5rem; font-weight: 800; text-transform: uppercase; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; }
        .logo-letter:hover { color: var(--color-hover); transform: translateY(-2px); }
        .logo-subtitle { color: var(--color-platino); font-size: 0.9rem; font-weight: 500; letter-spacing: 1px; opacity: 0.9; text-transform: uppercase; }
        .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; }
        .nav-button { background: none; border: none; color: var(--color-platino); padding: 0.5rem 1rem; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease, background-color 0.3s; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 500; border-radius: 6px; }
        .nav-button:hover, .nav-button.active { color: var(--color-dorado); background-color: rgba(255, 255, 255, 0.05); transform: translateY(-2px); }
        .notification-icon { position: relative; color: var(--color-platino); cursor: pointer; }
        .notification-badge { position: absolute; top: -8px; right: -8px; background-color: var(--color-dorado); color: var(--color-negro); border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.8rem; }
        .main-container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .seccion { background-color: var(--color-card); border-radius: 12px; padding: 2rem; box-shadow: var(--shadow-strong); border: 1px solid rgba(255, 215, 0, 0.1); color: var(--color-texto-claro); content-visibility: auto; }
        .seccion-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid var(--color-dorado); padding-bottom: 1rem; flex-wrap: wrap; }
        .seccion-header h2 { color: var(--color-platino); font-size: 2rem; }
        #clock-container { font-size: 1.2rem; font-weight: 500; color: var(--color-platino); text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); min-width: 300px; min-height: 1.5rem; }
        .summary-widget-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem; }
        .summary-card { background: linear-gradient(145deg, #3a3a3a, #202020); border-radius: 10px; padding: 1.5rem; box-shadow: var(--shadow-soft); border-left: 5px solid; min-height: 120px; contain: layout; }
        .summary-card.clientes { border-color: #4a90e2; }
        .summary-card.tareas { border-color: #f5a623; }
        .summary-card.eventos { border-color: #7ed321; }
        .summary-card-header { font-size: 1.1rem; font-weight: 600; color: var(--color-platino); margin-bottom: 1rem; min-height: 1.5rem; }
        .summary-card-body { display: flex; align-items: center; justify-content: space-between; font-size: 2.5rem; font-weight: 700; color: var(--color-texto-claro); gap: 1rem; min-height: 3rem; }
        .summary-card-body i { font-size: 2.5rem; opacity: 0.7; flex-shrink: 0; width: 2.5rem; height: 2.5rem; }
        .summary-card-body span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; text-align: right; min-width: 0; font-size: clamp(1.5rem, 2.5vw, 2.5rem); }
        #recent-activity-container { margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 215, 0, 0.1); }
        #recent-activity-container h3 { color: var(--color-platino); margin-bottom: 1rem; font-size: 1.5rem; }
        #recent-activity-list { list-style: none; padding: 0; }
        .activity-item { background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s; }
        .activity-item:hover { background-color: rgba(0,0,0,0.4); }
        .activity-item span { font-size: 1rem; }
        .activity-item small { color: var(--color-platino); opacity: 0.7; }
        .hidden { display: none !important; }
        .herramientas-contables, .reportes-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .herramienta-card, .reporte-card { background: linear-gradient(145deg, var(--color-card), var(--color-negro)); border-radius: 15px; padding: 2rem; box-shadow: var(--shadow-strong); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255, 215, 0, 0.1); position: relative; overflow: hidden; cursor: pointer; }
        .herramienta-card:hover, .reporte-card:hover { transform: translateY(-8px); box-shadow: var(--glow-dorado); border-color: rgba(255, 215, 0, 0.2); }
        .herramienta-card h3, .reporte-card h3 { color: var(--color-dorado); font-size: 1.4rem; margin-bottom: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; }
        .herramienta-card p, .reporte-card p { color: var(--color-texto-claro); font-size: 1rem; line-height: 1.6; opacity: 0.9; }
        .tabla-container { color: var(--color-texto-claro); overflow-x: auto; background: #333; border-radius: 8px; padding: 0.5rem; }
        .modal-content { color: var(--color-texto-claro); }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; background-color: #3a3a3a; border-radius: 8px; overflow: hidden; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #555; }
        th { background-color: #202020; }
        .form-group label { color: var(--color-platino); margin-bottom: 0.5rem; display: block; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #555; border-radius: 4px; background-color: #333; color: var(--color-texto-claro); }
        .btn-primary { background-color: var(--color-dorado); color: var(--color-negro); border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
        .btn-primary:hover { background-color: var(--color-hover); }
        .btn-secondary { background-color: #555; color: var(--color-platino); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .btn-error { background-color: var(--color-error); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .btn-info { background-color: #17a2b8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--color-card); margin: 5% auto; padding: 20px; border: 1px solid var(--color-dorado); width: 80%; max-width: 700px; border-radius: 10px; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-modal:hover, .close-modal:focus { color: var(--color-platino); text-decoration: none; cursor: pointer; }
        .notas-container { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; }
        .lista-notas { max-height: 60vh; overflow-y: auto; }
        .nota-item { background: #333; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; cursor: pointer; border-left: 4px solid var(--color-dorado); }
        .nota-item.active { background: var(--color-dorado); color: var(--color-negro); }
        .editor-notas input, .editor-notas textarea { margin-bottom: 1rem; }
        .editor-notas textarea { min-height: 40vh; resize: vertical; }
        .calendario-grid .con-eventos { background-color: rgba(255, 215, 0, 0.3); border-radius: 50%; }
        .search-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .search-bar input { flex: 1; padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); }
        .calculadora-container { max-width: 500px; margin: 2rem auto; padding: 2rem; background: rgba(255,215,0,0.05); border-radius: 12px; }
        .calendario-container { margin-top: 1rem; }
        .calendario-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: rgba(255,215,0,0.05); border-radius: 8px; }
        .calendario-nav button { background: var(--color-dorado); color: var(--color-negro); border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .calendario-nav button:hover { background: var(--color-hover); }
        .calendario-nav h3 { color: var(--color-dorado); font-size: 1.5rem; }
        .resultado-container { padding: 2rem; background: var(--color-card); border-radius: 12px; margin-top: 2rem; }
        .toast-container { position: fixed; top: 80px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; max-width: 420px; pointer-events: none; }
        .toast { background: linear-gradient(145deg, rgba(42, 42, 42, 0.98) 0%, rgba(26, 26, 26, 0.98) 100%); backdrop-filter: blur(10px); color: var(--color-texto-claro); padding: 1.25rem 1.75rem; border-radius: 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,215,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1); display: flex; align-items: center; gap: 1.25rem; animation: toastSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); position: relative; overflow: hidden; border-left: 5px solid var(--color-dorado); pointer-events: auto; transform-origin: right center; }
        .toast::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--color-dorado) 0%, rgba(255,215,0,0.3) 100%); animation: toastProgress 4s linear forwards; box-shadow: 0 2px 8px rgba(255,215,0,0.4); }
        .toast::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, rgba(255,215,0,0.15) 0%, transparent 60%); pointer-events: none; }
        .toast.success { border-left-color: var(--color-exito); background: linear-gradient(145deg, rgba(42, 42, 42, 0.98) 0%, rgba(26, 42, 26, 0.98) 100%); }
        .toast.success::before { background: linear-gradient(90deg, var(--color-exito) 0%, rgba(76,175,80,0.3) 100%); box-shadow: 0 2px 8px rgba(76,175,80,0.4); }
        .toast.success::after { background: radial-gradient(circle at top right, rgba(76,175,80,0.2) 0%, transparent 60%); }
        .toast.error { border-left-color: var(--color-error); background: linear-gradient(145deg, rgba(42, 42, 42, 0.98) 0%, rgba(42, 26, 26, 0.98) 100%); }
        .toast.error::before { background: linear-gradient(90deg, var(--color-error) 0%, rgba(255,82,82,0.3) 100%); box-shadow: 0 2px 8px rgba(255,82,82,0.4); }
        .toast.error::after { background: radial-gradient(circle at top right, rgba(255,82,82,0.2) 0%, transparent 60%); }
        .toast.warning { border-left-color: #f39c12; background: linear-gradient(145deg, rgba(42, 42, 42, 0.98) 0%, rgba(42, 35, 26, 0.98) 100%); }
        .toast.warning::before { background: linear-gradient(90deg, #f39c12 0%, rgba(243,156,18,0.3) 100%); box-shadow: 0 2px 8px rgba(243,156,18,0.4); }
        .toast.warning::after { background: radial-gradient(circle at top right, rgba(243,156,18,0.2) 0%, transparent 60%); }
        .toast-icon { font-size: 2rem; flex-shrink: 0; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; position: relative; z-index: 1; }
        .toast.success .toast-icon { color: var(--color-exito); background: rgba(76,175,80,0.15); box-shadow: 0 0 20px rgba(76,175,80,0.3), inset 0 0 20px rgba(76,175,80,0.1); animation: iconPulse 2s ease-in-out infinite; }
        .toast.error .toast-icon { color: var(--color-error); background: rgba(255,82,82,0.15); box-shadow: 0 0 20px rgba(255,82,82,0.3), inset 0 0 20px rgba(255,82,82,0.1); animation: iconShake 0.5s ease-in-out; }
        .toast.warning .toast-icon { color: #f39c12; background: rgba(243,156,18,0.15); box-shadow: 0 0 20px rgba(243,156,18,0.3), inset 0 0 20px rgba(243,156,18,0.1); animation: iconBounce 0.6s ease-in-out; }
        .toast.info .toast-icon { color: var(--color-dorado); background: rgba(255,215,0,0.15); box-shadow: 0 0 20px rgba(255,215,0,0.3), inset 0 0 20px rgba(255,215,0,0.1); }
        .toast-content { flex: 1; position: relative; z-index: 1; }
        .toast-title { font-weight: 700; margin-bottom: 0.35rem; font-size: 1.1rem; letter-spacing: 0.3px; }
        .toast-message { font-size: 0.95rem; opacity: 0.9; line-height: 1.4; }
        .toast-close { background: rgba(255,255,255,0.1); border: none; color: var(--color-platino); cursor: pointer; font-size: 1.1rem; opacity: 0.7; transition: all 0.3s; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; position: relative; z-index: 1; }
        .toast-close:hover { opacity: 1; background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        @keyframes toastSlideIn { 
            from { transform: translateX(450px) scale(0.8); opacity: 0; } 
            to { transform: translateX(0) scale(1); opacity: 1; } 
        }
        @keyframes toastProgress { from { width: 100%; } to { width: 0%; } }
        @keyframes iconPulse { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.1); } 
        }
        @keyframes iconShake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-5px) rotate(-5deg); } 
            75% { transform: translateX(5px) rotate(5deg); } 
        }
        @keyframes iconBounce { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-8px); } 
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9998; display: none; animation: fadeIn 0.3s; }
        .modal-overlay.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="intro-overlay" id="introOverlay">
        <div class="intro-vignette"></div>
        <div class="intro-cinematic-bars top"></div>
        <div class="intro-cinematic-bars bottom"></div>
        <div class="intro-bg-stars"></div>
        <div class="intro-nebula"></div>
        <div class="intro-light-beam"></div>
        <div class="intro-light-beam"></div>
        <div class="intro-light-beam"></div>
        <div class="intro-glow"></div>
        <div class="intro-ring"></div>
        <div class="intro-flash"></div>
        <div class="intro-particles" id="introParticles"></div>
        <div class="intro-content">
            <div class="intro-logo-container">
                <div class="intro-logo">
                    <span class="intro-letter" data-letter="A">A</span>
                    <span class="intro-letter" data-letter="J">J</span>
                    <span class="intro-letter" data-letter="H">H</span>
                    <span class="intro-letter" data-letter="B">B</span>
                </div>
            </div>
            <div class="intro-subtitle">Bienes Raíces</div>
        </div>
        <div class="intro-credit">Creado y Distribuido por ValorumHoldings</div>
    </div>
    <nav class="navbar">
        <div class="logo-container">
            <div class="logo-text"><span class="logo-letter">A</span><span class="logo-letter">J</span><span class="logo-letter">H</span><span class="logo-letter">B</span></div>
            <div class="logo-subtitle">Contabilidad Profesional</div>
        </div>
        <div class="nav-links">
            <button class="nav-button" onclick="mostrarSeccion('inicio', this)"><i class="fas fa-home"></i> Inicio</button>
            <button class="nav-button" onclick="mostrarSeccion('contabilidad', this)"><i class="fas fa-book"></i> Contabilidad</button>
            <button class="nav-button" onclick="mostrarSeccion('clientes', this)"><i class="fas fa-users"></i> Clientes</button>
            <button class="nav-button" onclick="mostrarSeccion('proveedores', this)"><i class="fas fa-truck"></i> Proveedores</button>
            <button class="nav-button" onclick="mostrarSeccion('cuentasCobrar', this)"><i class="fas fa-hand-holding-usd"></i> Cuentas x Cobrar</button>
            <button class="nav-button" onclick="mostrarSeccion('cuentasPagar', this)"><i class="fas fa-money-check-alt"></i> Cuentas x Pagar</button>
            <button class="nav-button" onclick="mostrarSeccion('activos', this)"><i class="fas fa-building"></i> Activos</button>
            <button class="nav-button" onclick="mostrarSeccion('bancos', this)"><i class="fas fa-university"></i> Bancos</button>
            <button class="nav-button" onclick="mostrarSeccion('reportes', this)"><i class="fas fa-chart-line"></i> Reportes</button>
            <button class="nav-button" onclick="mostrarSeccion('herramientas', this)"><i class="fas fa-tools"></i> Herramientas</button>
            <button class="nav-button" onclick="mostrarSeccion('notas', this)"><i class="fas fa-sticky-note"></i> Notas</button>
            <button class="nav-button" onclick="mostrarSeccion('calendario', this)"><i class="fas fa-calendar-alt"></i> Calendario</button>
        </div>
        <div class="notification-icon" onclick="mostrarNotificaciones()"><i class="fas fa-bell"></i><span class="notification-badge" id="notificationCount">0</span></div>
    </nav>

    <main class="main-container">
        <section id="inicio" class="seccion">
            <div class="seccion-header"><h2>Panel Principal</h2><div id="clock-container"></div></div>
            <div class="summary-widget-grid">
                <div class="summary-card clientes"><div class="summary-card-header">Total de Clientes</div><div class="summary-card-body"><i class="fas fa-users"></i><span id="totalClientesWidget">0</span></div></div>
                <div class="summary-card tareas"><div class="summary-card-header">Cuentas por Cobrar</div><div class="summary-card-body"><i class="fas fa-hand-holding-usd"></i><span id="cuentasCobrarWidget">₡0</span></div></div>
                <div class="summary-card eventos"><div class="summary-card-header">Cuentas por Pagar</div><div class="summary-card-body"><i class="fas fa-money-check-alt"></i><span id="cuentasPagarWidget">₡0</span></div></div>
                <div class="summary-card clientes" style="border-color: #9b59b6;"><div class="summary-card-header">Asientos Contables</div><div class="summary-card-body"><i class="fas fa-book"></i><span id="asientosWidget">0</span></div></div>
                <div class="summary-card tareas" style="border-color: #e74c3c;"><div class="summary-card-header">Activos Registrados</div><div class="summary-card-body"><i class="fas fa-building"></i><span id="activosWidget">0</span></div></div>
                <div class="summary-card eventos" style="border-color: #1abc9c;"><div class="summary-card-header">Saldo en Bancos</div><div class="summary-card-body"><i class="fas fa-university"></i><span id="saldoBancosWidget">₡0</span></div></div>
            </div>
            <div id="recent-activity-container"><h3><i class="fas fa-history"></i> Actividad Reciente</h3><ul id="recent-activity-list"><li class="activity-item"><span>Cargando...</span></li></ul></div>
        </section>

        <section id="clientes" class="seccion hidden">
            <div class="seccion-header">
                <h2>Gestión de Clientes</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-secondary" onclick="exportarClientesExcel()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                    <button class="btn-primary" onclick="abrirFormularioCliente()"><i class="fas fa-plus"></i> Nuevo Cliente</button>
                </div>
            </div>
            <div class="search-bar"><input type="text" id="buscarCliente" placeholder="Buscar cliente..."><button class="btn-primary" onclick="buscarClientes()"><i class="fas fa-search"></i></button></div>
            <div class="tabla-container"><table id="tablaClientes"><thead><tr><th>ID</th><th>Nombre</th><th>Cédula</th><th>Email</th><th>Teléfono</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaClientes"></tbody></table></div>
        </section>

        <section id="vouchers" class="seccion hidden">
            <div class="seccion-header"><h2>Generación de Vouchers</h2><button class="btn-primary" onclick="abrirFormularioVoucher()"><i class="fas fa-plus"></i> Nuevo Voucher</button></div>
            <div class="search-bar"><input type="text" id="buscarVoucher" placeholder="Buscar voucher..."><button class="btn-primary" onclick="buscarVouchers()"><i class="fas fa-search"></i></button></div>
            <div class="tabla-container"><table id="tablaVouchers"><thead><tr><th>ID</th><th>Cliente</th><th>Tipo</th><th>Número</th><th>Fecha</th><th>Total</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaVouchers"></tbody></table></div>
        </section>

        <section id="impuestos" class="seccion hidden">
            <div class="seccion-header"><h2>Calculadora de IVA</h2></div>
            <div class="calculadora-container"><div class="form-group"><label>Monto Base:</label><input type="number" id="montoBase" step="0.01"></div><div class="form-group"><label>Tipo de IVA:</label><select id="tipoIVA"><option value="0.13">13% (General)</option><option value="0.04">4% (Reducido)</option><option value="0.02">2% (Preferencial)</option><option value="0.01">1% (Canasta Básica)</option></select></div><button class="btn-primary" onclick="calcularIVA()">Calcular</button><div class="resultados-iva" style="color: var(--color-texto-claro); margin-top: 1rem;"><div>Monto IVA: <span id="montoIVA">₡0</span></div><div>Total con IVA: <span id="totalConIVA">₡0</span></div></div></div>
        </section>

        <section id="herramientas" class="seccion hidden">
            <div class="seccion-header"><h2>Herramientas Contables</h2></div>
            <div class="herramientas-contables">
                <div class="herramienta-card" onclick="abrirDepreciacion()"><h3><i class="fas fa-calculator"></i> Calculadora de Depreciación</h3><p>Calcule la depreciación de activos por línea recta o saldos decrecientes con resultados instantáneos.</p></div>
                <div class="herramienta-card" onclick="abrirAnalisisCuentas()"><h3><i class="fas fa-file-invoice-dollar"></i> Análisis de Cuentas</h3><p>Análisis completo de cuentas por cobrar y pagar con indicadores financieros en tiempo real.</p></div>
                <div class="herramienta-card" onclick="abrirConciliacion()"><h3><i class="fas fa-balance-scale"></i> Conciliación Bancaria</h3><p>Concilie sus cuentas bancarias comparando saldos de libros vs extractos bancarios.</p></div>
                <div class="herramienta-card" onclick="mostrarSeccion('contabilidad', this)"><h3><i class="fas fa-book"></i> Catálogo de Cuentas</h3><p>Acceda al catálogo completo de cuentas contables organizadas jerárquicamente.</p></div>
                <div class="herramienta-card" onclick="calcularIVA(); mostrarSeccion('impuestos', this)"><h3><i class="fas fa-percent"></i> Calculadora de IVA</h3><p>Calcule el IVA con diferentes tasas: 13%, 4%, 2% y 1% según la categoría del producto.</p></div>
                <div class="herramienta-card" onclick="generarResumenFinanciero()"><h3><i class="fas fa-chart-pie"></i> Resumen Financiero</h3><p>Vista consolidada de la situación financiera actual de la empresa con gráficos.</p></div>
            </div>
        </section>

        <section id="notas" class="seccion hidden">
            <div class="seccion-header">
                <div>
                    <h2><i class="fas fa-sticky-note"></i> Bloc de Notas Avanzado</h2>
                    <p style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.25rem;">Total: <span id="totalNotas">0</span> notas</p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-secondary" onclick="exportarNotasPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                    <button class="btn-primary" onclick="nuevaNota()"><i class="fas fa-plus"></i> Nueva Nota</button>
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="buscarNota" placeholder="Buscar en notas..." onkeyup="buscarNotas()" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro);">
            </div>
            <div class="notas-container">
                <div class="lista-notas" id="listaNotas" style="max-height: 600px; overflow-y: auto;"></div>
                <div class="editor-notas" style="background: rgba(255,215,0,0.05); padding: 1.5rem; border-radius: 8px;">
                    <input type="hidden" id="idNota">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="tituloNota" placeholder="Título de la nota" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); font-size: 1.1rem; font-weight: bold;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; opacity: 0.8;"><i class="fas fa-folder"></i> Categoría</label>
                            <select id="categoriaNota" style="width: 100%; padding: 0.5rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro);">
                                <option value="general">General</option>
                                <option value="trabajo">Trabajo</option>
                                <option value="personal">Personal</option>
                                <option value="ideas">Ideas</option>
                                <option value="reuniones">Reuniones</option>
                                <option value="tareas">Tareas</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; opacity: 0.8;"><i class="fas fa-exclamation-circle"></i> Prioridad</label>
                            <select id="prioridadNota" style="width: 100%; padding: 0.5rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro);">
                                <option value="baja">Baja</option>
                                <option value="media" selected>Media</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; opacity: 0.8;"><i class="fas fa-tags"></i> Etiquetas</label>
                            <input type="text" id="etiquetasNota" placeholder="ej: cliente, urgente" style="width: 100%; padding: 0.5rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro);">
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <textarea id="contenidoNota" placeholder="Escribe tu nota aquí..." oninput="actualizarContadorCaracteres()" style="width: 100%; min-height: 300px; padding: 1rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); resize: vertical; font-family: 'Segoe UI', sans-serif; line-height: 1.6;"></textarea>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                            <small id="contadorCaracteres" style="opacity: 0.7;">0 caracteres | 0 palabras</small>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="archivarNota">
                                <span style="opacity: 0.8;"><i class="fas fa-archive"></i> Archivar nota</span>
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn-primary" onclick="guardarNota()" style="flex: 1;"><i class="fas fa-save"></i> Guardar Nota</button>
                        <button class="btn-secondary" onclick="nuevaNota()"><i class="fas fa-file"></i> Limpiar</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="calendario" class="seccion hidden">
            <div class="seccion-header"><h2>Calendario</h2><button class="btn-primary" onclick="abrirFormularioEvento()"><i class="fas fa-plus"></i> Nuevo Evento</button></div>
            <div class="calendario-container"><div class="calendario-nav"><button onclick="cambiarMes(-1)"><i class="fas fa-chevron-left"></i></button><h3 id="mesActual"></h3><button onclick="cambiarMes(1)"><i class="fas fa-chevron-right"></i></button></div><div class="calendario-grid" id="calendarioGrid"></div></div>
            <div id="eventosDia" style="margin-top: 1rem;"></div>
        </section>

        <section id="contabilidad" class="seccion hidden">
            <div class="seccion-header"><h2>Sistema Contable</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-secondary" onclick="exportarAsientosExcel()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                    <button class="btn-primary" onclick="abrirFormularioAsiento()"><i class="fas fa-plus"></i> Nuevo Asiento</button>
                    <button class="btn-secondary" onclick="mostrarCatalogoCuentas()"><i class="fas fa-list"></i> Catálogo de Cuentas</button>
                </div>
            </div>
            <div class="search-bar"><input type="text" id="buscarAsiento" placeholder="Buscar por número o descripción..."><button class="btn-primary" onclick="buscarAsientos()"><i class="fas fa-search"></i></button></div>
            <div class="tabla-container"><table id="tablaAsientos"><thead><tr><th>Número</th><th>Fecha</th><th>Tipo</th><th>Descripción</th><th>Total Debe</th><th>Total Haber</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaAsientos"></tbody></table></div>
        </section>

        <section id="proveedores" class="seccion hidden">
            <div class="seccion-header"><h2>Gestión de Proveedores</h2><button class="btn-primary" onclick="abrirFormularioProveedor()"><i class="fas fa-plus"></i> Nuevo Proveedor</button></div>
            <div class="search-bar"><input type="text" id="buscarProveedor" placeholder="Buscar proveedor..."><button class="btn-primary" onclick="buscarProveedores()"><i class="fas fa-search"></i></button></div>
            <div class="tabla-container"><table id="tablaProveedores"><thead><tr><th>ID</th><th>Nombre</th><th>Cédula</th><th>Email</th><th>Teléfono</th><th>Saldo</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaProveedores"></tbody></table></div>
        </section>

        <section id="cuentasCobrar" class="seccion hidden">
            <div class="seccion-header">
                <h2>Cuentas por Cobrar</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-secondary" onclick="exportarCuentasCobrarExcel()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                    <button class="btn-primary" onclick="abrirFormularioCuentaCobrar()"><i class="fas fa-plus"></i> Nueva Cuenta</button>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn-secondary" onclick="filtrarCuentasCobrar('todas')">Todas</button>
                <button class="btn-secondary" onclick="filtrarCuentasCobrar('pendientes')">Pendientes</button>
                <button class="btn-secondary" onclick="filtrarCuentasCobrar('vencidas')">Vencidas</button>
                <button class="btn-secondary" onclick="filtrarCuentasCobrar('pagadas')">Pagadas</button>
            </div>
            <div class="tabla-container"><table id="tablaCuentasCobrar"><thead><tr><th>ID</th><th>Cliente</th><th>Monto</th><th>Saldo</th><th>Fecha Emisión</th><th>Vencimiento</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaCuentasCobrar"></tbody></table></div>
        </section>

        <section id="cuentasPagar" class="seccion hidden">
            <div class="seccion-header"><h2>Cuentas por Pagar</h2><button class="btn-primary" onclick="abrirFormularioCuentaPagar()"><i class="fas fa-plus"></i> Nueva Cuenta</button></div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn-secondary" onclick="filtrarCuentasPagar('todas')">Todas</button>
                <button class="btn-secondary" onclick="filtrarCuentasPagar('pendientes')">Pendientes</button>
                <button class="btn-secondary" onclick="filtrarCuentasPagar('vencidas')">Vencidas</button>
                <button class="btn-secondary" onclick="filtrarCuentasPagar('pagadas')">Pagadas</button>
            </div>
            <div class="tabla-container"><table id="tablaCuentasPagar"><thead><tr><th>ID</th><th>Proveedor</th><th>Monto</th><th>Saldo</th><th>Fecha Emisión</th><th>Vencimiento</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaCuentasPagar"></tbody></table></div>
        </section>

        <section id="activos" class="seccion hidden">
            <div class="seccion-header"><h2>Gestión de Activos Fijos</h2><button class="btn-primary" onclick="abrirFormularioActivo()"><i class="fas fa-plus"></i> Nuevo Activo</button></div>
            <div class="search-bar"><input type="text" id="buscarActivo" placeholder="Buscar activo..."><button class="btn-primary" onclick="buscarActivos()"><i class="fas fa-search"></i></button></div>
            <div class="tabla-container"><table id="tablaActivos"><thead><tr><th>ID</th><th>Descripción</th><th>Categoría</th><th>Valor Compra</th><th>Depreciación Acum.</th><th>Valor en Libros</th><th>Fecha Compra</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaActivos"></tbody></table></div>
        </section>

        <section id="bancos" class="seccion hidden">
            <div class="seccion-header"><h2>Gestión Bancaria</h2><button class="btn-primary" onclick="abrirFormularioBanco()"><i class="fas fa-plus"></i> Nueva Cuenta Bancaria</button></div>
            <div class="tabla-container"><table id="tablaBancos"><thead><tr><th>ID</th><th>Banco</th><th>Número de Cuenta</th><th>Tipo</th><th>Saldo Actual</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaBancos"></tbody></table></div>
            <div id="movimientosBancarios" style="margin-top: 2rem; display: none;">
                <div class="seccion-header"><h3>Movimientos Bancarios</h3><button class="btn-primary" onclick="abrirFormularioMovimiento()"><i class="fas fa-plus"></i> Nuevo Movimiento</button></div>
                <div class="tabla-container"><table id="tablaMovimientos"><thead><tr><th>Fecha</th><th>Tipo</th><th>Descripción</th><th>Monto</th><th>Saldo</th><th>Acciones</th></tr></thead><tbody id="cuerpoTablaMovimientos"></tbody></table></div>
            </div>
        </section>

        <section id="reportes" class="seccion hidden">
            <div class="seccion-header">
                <h2>Reportes Financieros</h2>
                <button class="btn-secondary" onclick="exportarReportePDF('actual')" id="btnExportarReporte" style="display: none;"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
            </div>
            <div class="reportes-container">
                <div class="reporte-card" onclick="generarReporte('balance')"><h3><i class="fas fa-balance-scale-right"></i> Balance General</h3><p>Muestra activos, pasivos y patrimonio.</p></div>
                <div class="reporte-card" onclick="generarReporte('resultados')"><h3><i class="fas fa-chart-bar"></i> Estado de Resultados</h3><p>Detalla ingresos, costos y gastos.</p></div>
                <div class="reporte-card" onclick="generarReporte('flujo')"><h3><i class="fas fa-cash-register"></i> Flujo de Caja</h3><p>Rastrea el movimiento de efectivo.</p></div>
                <div class="reporte-card" onclick="generarReporte('mayor')"><h3><i class="fas fa-book-open"></i> Libro Mayor</h3><p>Detalle de movimientos por cuenta.</p></div>
                <div class="reporte-card" onclick="generarReporte('diario')"><h3><i class="fas fa-journal-whills"></i> Libro Diario</h3><p>Registro cronológico de asientos.</p></div>
                <div class="reporte-card" onclick="generarReporte('balanceComprobacion')"><h3><i class="fas fa-clipboard-check"></i> Balance de Comprobación</h3><p>Verificación de saldos contables.</p></div>
            </div>
            <div id="contenedorReporte" class="resultado-container hidden" style="margin-top: 2rem; color: var(--color-texto-claro); background: var(--color-card); padding: 1rem; border-radius: 8px;"></div>
        </section>

        <div id="modal" class="modal hidden"><div class="modal-content"><span class="close-modal">&times;</span><div id="modal-contenido"></div></div></div>
    </main>

    <div id="particles-container"></div>
    <div class="grid-line grid-line-h" style="top: 20%;"></div>
    <div class="grid-line grid-line-h" style="top: 60%;"></div>
    <div class="grid-line grid-line-v" style="left: 30%;"></div>
    <div class="grid-line grid-line-v" style="left: 70%;"></div>
    <div id="toast-container" class="toast-container"></div>

    <script src="api_client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autotable@3.5.14/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        (function(){
            const particlesContainer=document.getElementById('introParticles');
            for(let i=0;i<30;i++){
                const p=document.createElement('div');
                p.className='intro-particle';
                const size=Math.random()*3+2;
                p.style.width=size+'px';
                p.style.height=size+'px';
                p.style.left=Math.random()*100+'%';
                p.style.bottom='-10px';
                const duration=Math.random()*3+2;
                const delay=Math.random()*2;
                const hue=Math.random()*360;
                p.style.background=`hsl(${hue}, 100%, 60%)`;
                p.style.animation=`particleRise ${duration}s ease-out ${delay}s forwards`;
                p.style.willChange='transform';
                particlesContainer.appendChild(p);
            }
            const style=document.createElement('style');
            style.textContent=`
                @keyframes particleRise {
                    0% {
                        opacity: 0;
                        transform: translateY(0) scale(0);
                    }
                    20% {
                        opacity: 1;
                    }
                    80% {
                        opacity: 1;
                    }
                    100% {
                        opacity: 0;
                        transform: translateY(-100vh) scale(1.5);
                    }
                }
            `;
            document.head.appendChild(style);
            setTimeout(()=>{
                const overlay=document.getElementById('introOverlay');
                if(overlay){
                    overlay.style.opacity = '0';
                    overlay.style.pointerEvents = 'none';
                    setTimeout(() => overlay.remove(), 1000);
                }
            },6000);
        })();
        (function(){const _0x3c1d='AJHB-SECURE-SALT-2025-BIENES-RAICES-SYSTEM';function _0x1b6c(t){try{const e=CryptoJS.AES.decrypt(t,_0x3c1d);return e.toString(CryptoJS.enc.Utf8);}catch(e){return null;}}const s=localStorage.getItem('ajhb_session');if(!s){window.location.href='login1.html';return;}try{const d=_0x1b6c(s);if(!d){localStorage.removeItem('ajhb_session');localStorage.removeItem('ajhb_user');window.location.href='login1.html';return;}const[u,t]=d.split('|');const n=new Date().getTime();const st=parseInt(t);if(n-st>=8*60*60*1000){localStorage.removeItem('ajhb_session');localStorage.removeItem('ajhb_user');alert('Su sesión ha expirado. Por favor, inicie sesión nuevamente.');window.location.href='login1.html';return;}const uc=localStorage.getItem('ajhb_user');if(uc){const un=_0x1b6c(uc);if(un){window.addEventListener('DOMContentLoaded',function(){const nb=document.querySelector('.navbar');if(nb){const ui=document.createElement('div');ui.style.cssText='display: flex; align-items: center; gap: 0.5rem; color: var(--color-dorado); font-weight: 500;';ui.innerHTML=`<i class="fas fa-user-circle"></i><span>${un}</span><button onclick="cerrarSesion()" style="background: rgba(255,82,82,0.2); border: 1px solid var(--color-error); color: var(--color-error); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: 1rem; transition: all 0.3s;"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>`;nb.appendChild(ui);}});}}}catch(e){localStorage.removeItem('ajhb_session');localStorage.removeItem('ajhb_user');window.location.href='login1.html';}})();
        function cerrarSesion() {
            confirmarAccion(
                'Se cerrará su sesión y deberá iniciar sesión nuevamente.',
                () => {
                    localStorage.removeItem('ajhb_session');
                    localStorage.removeItem('ajhb_user');
                    window.location.href = 'login1.html';
                },
                '¿Cerrar Sesión?'
            );
        }
        // ==================== BACKEND API (Reemplaza IndexedDB) ====================
        // IndexedDB ha sido reemplazado por el backend en backendconta.py
        // Todas las operaciones ahora se hacen a través de api_client.js
        
        let calendarioFechaActual = new Date();
        let notaSeleccionadaId = null;
        let cuentaSeleccionada = null;
        let asientoActual = { debe: [], haber: [] };
        
        // Definir mostrarSeccion PRIMERO para que esté disponible globalmente
        window.mostrarSeccion = function(seccionId, btnElement) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.add('hidden'));
            document.getElementById(seccionId).classList.remove('hidden');
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');

            const carga = {
                inicio: () => { 
                    if (typeof actualizarWidgets === 'function') actualizarWidgets(); 
                    if (typeof actualizarActividadReciente === 'function') actualizarActividadReciente(); 
                },
                contabilidad: () => { if (typeof cargarAsientos === 'function') cargarAsientos(); },
                clientes: () => { if (typeof cargarClientes === 'function') cargarClientes(); },
                proveedores: () => { if (typeof cargarProveedores === 'function') cargarProveedores(); },
                cuentasCobrar: () => { if (typeof cargarCuentasCobrar === 'function') cargarCuentasCobrar(); },
                cuentasPagar: () => { if (typeof cargarCuentasPagar === 'function') cargarCuentasPagar(); },
                activos: () => { if (typeof cargarActivos === 'function') cargarActivos(); },
                bancos: () => { if (typeof cargarBancos === 'function') cargarBancos(); },
                reportes: () => {},
                herramientas: () => {},
                notas: () => { if (typeof cargarNotas === 'function') cargarNotas(); },
                calendario: () => { if (typeof inicializarCalendario === 'function') inicializarCalendario(); }
            };
            if (carga[seccionId]) carga[seccionId]();
        };
        
        const initDB = async () => {
            try {
                // Verificar conexión con el backend
                await api.healthCheck();
                console.log('✅ Backend conectado correctamente');
                
                // Inicializar catálogo de cuentas si es necesario
                await DB.inicializarCatalogoCuentas();
                
                // Cargar datos iniciales
                setTimeout(() => {
                    mostrarSeccion('inicio', document.querySelector('.nav-button'));
                }, 100);
            } catch (error) {
                console.error('Error inicializando:', error);
                mostrarToast('Error al conectar con el servidor. Verifica que el backend esté ejecutándose en http://localhost:5000', 'error', 'Error de Conexión');
            }
        };
        
        const abrirModal = (content) => {
            document.getElementById('modal-contenido').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
        };
        
        const cerrarModal = () => document.getElementById('modal').classList.add('hidden');
        
        const mostrarToast = (mensaje, tipo = 'info', titulo = '') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            
            const iconos = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const titulos = {
                success: titulo || 'Éxito',
                error: titulo || 'Error',
                warning: titulo || 'Advertencia',
                info: titulo || 'Información'
            };
            
            toast.innerHTML = `
                <div class="toast-icon"><i class="fas ${iconos[tipo]}"></i></div>
                <div class="toast-content">
                    <div class="toast-title">${titulos[tipo]}</div>
                    <div class="toast-message">${mensaje}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.4s reverse';
                setTimeout(() => toast.remove(), 400);
            }, 4000);
        };
        
        const confirmarAccion = (mensaje, onConfirm, titulo = '¿Está seguro?') => {
            const modalHTML = `
                <div style="text-align: center; padding: 3rem 2rem; background: linear-gradient(145deg, rgba(42,42,42,0.95), rgba(26,26,26,0.95)); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);">
                    <div style="position: relative; display: inline-block; margin-bottom: 1.5rem;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 120px; background: radial-gradient(circle, rgba(243,156,18,0.3) 0%, transparent 70%); border-radius: 50%; animation: pulseGlow 2s ease-in-out infinite;"></div>
                        <div style="position: relative; width: 100px; height: 100px; background: linear-gradient(145deg, rgba(243,156,18,0.2), rgba(243,156,18,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(243,156,18,0.4), inset 0 0 20px rgba(243,156,18,0.1); animation: iconFloat 3s ease-in-out infinite;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3.5rem; color: #f39c12; filter: drop-shadow(0 0 10px rgba(243,156,18,0.6)); animation: iconShake 0.5s ease-in-out;"></i>
                        </div>
                    </div>
                    <h3 style="color: var(--color-dorado); margin-bottom: 1rem; font-size: 1.8rem; font-weight: 700; text-shadow: 0 2px 10px rgba(255,215,0,0.3); letter-spacing: 0.5px;">${titulo}</h3>
                    <p style="font-size: 1.15rem; margin-bottom: 2.5rem; opacity: 0.95; line-height: 1.6; max-width: 400px; margin-left: auto; margin-right: auto; color: var(--color-platino);">${mensaje}</p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="btn-secondary" onclick="cerrarModal()" style="padding: 1rem 2.5rem; font-size: 1.05rem; border-radius: 12px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: 600;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn-error" id="btnConfirmar" style="padding: 1rem 2.5rem; font-size: 1.05rem; border-radius: 12px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(255,82,82,0.4); font-weight: 600; position: relative; overflow: hidden;">
                            <span style="position: relative; z-index: 1;"><i class="fas fa-check"></i> Confirmar</span>
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transform: translateX(-100%); animation: shimmer 2s infinite;"></div>
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes pulseGlow {
                        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
                        50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
                    }
                    @keyframes iconFloat {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    @keyframes shimmer {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(200%); }
                    }
                    .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.4); }
                    #btnConfirmar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,82,82,0.6); }
                </style>
            `;
            abrirModalConContenido(modalHTML);
            setTimeout(() => {
                document.getElementById('btnConfirmar').onclick = () => {
                    cerrarModal();
                    onConfirm();
                };
            }, 100);
        };

        window.onload = () => {
            initDB();
            setInterval(actualizarReloj, 1000);
            actualizarReloj();
            document.querySelector('.close-modal').onclick = cerrarModal;
            window.onclick = (event) => { if (event.target == document.getElementById('modal')) cerrarModal(); };
            setTimeout(() => {
                actualizarContadorNotificaciones();
                setInterval(actualizarContadorNotificaciones, 30000);
            }, 2000);
            crearParticulas();
        };
        const crearParticulas = () => {
            const container = document.getElementById('particles-container');
            const numParticulas = 30;
            
            for (let i = 0; i < numParticulas; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        };
        const actualizarReloj = () => {
            const el = document.getElementById('clock-container');
            if (el) el.textContent = new Date().toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'medium' });
        };
        const actualizarWidgets = async () => {
            try {
                const stats = await DB.getStats();
                document.getElementById('totalClientesWidget').textContent = stats.totalClientes || 0;
                document.getElementById('cuentasCobrarWidget').textContent = `₡${(stats.cuentasCobrar || 0).toFixed(2)}`;
                document.getElementById('cuentasPagarWidget').textContent = `₡${(stats.cuentasPagar || 0).toFixed(2)}`;
                document.getElementById('asientosWidget').textContent = stats.totalAsientos || 0;
                document.getElementById('activosWidget').textContent = stats.totalActivos || 0;
                document.getElementById('saldoBancosWidget').textContent = `₡${(stats.saldoBancos || 0).toFixed(2)}`;
            } catch (error) {
                console.warn('Error actualizando widgets:', error);
            }
        };
        
        const actualizarActividadReciente = async () => {
            const lista = document.getElementById('recent-activity-list');
            if (!lista) return;
            
            lista.innerHTML = '<li class="activity-item"><span>Cargando actividades...</span></li>';
            
            try {
                const [clientes, asientos, cxc, cxp, activos] = await Promise.all([
                    DB.getAll('clientes'),
                    DB.getAll('asientos'),
                    DB.getAll('cuentasPorCobrar'),
                    DB.getAll('cuentasPorPagar'),
                    DB.getAll('activos')
                ]);
                
                const actividades = [];
                clientes.forEach(c => {
                    if (c.fechaRegistro) {
                        actividades.push({
                            texto: `Cliente registrado: ${c.nombre}`,
                            fecha: new Date(c.fechaRegistro),
                            tipo: 'cliente',
                            icono: 'fa-user-plus'
                        });
                    }
                });
                asientos.forEach(a => {
                    if (a.fechaCreacion) {
                        actividades.push({
                            texto: `Asiento contable #${a.numero}`,
                            fecha: new Date(a.fechaCreacion),
                            tipo: 'asiento',
                            icono: 'fa-book'
                        });
                    }
                });
                cxc.forEach(c => {
                    if (c.fechaEmision) {
                        actividades.push({
                            texto: `Cuenta por cobrar: ₡${c.monto.toFixed(2)}`,
                            fecha: new Date(c.fechaEmision),
                            tipo: 'cobrar',
                            icono: 'fa-hand-holding-usd'
                        });
                    }
                });
                cxp.forEach(c => {
                    if (c.fechaEmision) {
                        actividades.push({
                            texto: `Cuenta por pagar: ₡${c.monto.toFixed(2)}`,
                            fecha: new Date(c.fechaEmision),
                            tipo: 'pagar',
                            icono: 'fa-money-check-alt'
                        });
                    }
                });
                activos.forEach(a => {
                    if (a.fechaRegistro) {
                        actividades.push({
                            texto: `Activo: ${a.descripcion}`,
                            fecha: new Date(a.fechaRegistro),
                            tipo: 'activo',
                            icono: 'fa-building'
                        });
                    }
                });
                
                actividades.sort((a, b) => b.fecha - a.fecha);
                lista.innerHTML = '';
                
                if (actividades.length === 0) {
                    lista.innerHTML = '<li class="activity-item"><span>No hay actividad reciente.</span></li>';
                } else {
                    actividades.slice(0, 10).forEach(act => {
                        const colorMap = {
                            cliente: '#4a90e2',
                            asiento: '#9b59b6',
                            cobrar: '#4CAF50',
                            pagar: '#e74c3c',
                            activo: '#f39c12'
                        };
                        lista.innerHTML += `
                            <li class="activity-item">
                                <span><i class="fas ${act.icono}" style="color: ${colorMap[act.tipo]}; margin-right: 0.5rem;"></i>${act.texto}</span>
                                <small>${act.fecha.toLocaleDateString('es-ES')}</small>
                            </li>
                        `;
                    });
                }
            } catch (error) {
                console.warn('Error actualizando actividad reciente:', error);
                lista.innerHTML = '<li class="activity-item"><span>No se pudo cargar la actividad reciente</span></li>';
            }
        };
        const abrirFormularioCliente = (id = null) => {
            const onsuccess = (cliente = {}) => {
                const isEdit = !!cliente.id;
                const formHTML = `
                    <h3 style="color: var(--color-dorado); margin-bottom: 1.5rem;">
                        <i class="fas fa-user-${isEdit ? 'edit' : 'plus'}"></i> ${isEdit ? 'Editar' : 'Nuevo'} Cliente
                    </h3>
                    <form id="formCliente" onsubmit="guardarCliente(event, ${isEdit ? cliente.id : 'null'})">
                        <div style="background: rgba(255,215,0,0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem; border-bottom: 2px solid var(--color-dorado); padding-bottom: 0.5rem;">
                                <i class="fas fa-id-card"></i> Información Personal
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label><i class="fas fa-user"></i> Nombre Completo *</label>
                                    <input type="text" id="nombre" value="${cliente.nombre || ''}" placeholder="Ej: Juan Pérez Gómez" required style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-id-badge"></i> Cédula/ID *</label>
                                    <input type="text" id="cedula" value="${cliente.cedula || ''}" placeholder="Ej: 1-2345-6789" required style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label><i class="fas fa-envelope"></i> Email *</label>
                                    <input type="email" id="email" value="${cliente.email || ''}" placeholder="ejemplo@correo.com" required style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-phone"></i> Teléfono *</label>
                                    <input type="tel" id="telefono" value="${cliente.telefono || ''}" placeholder="Ej: 8888-8888" required style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,215,0,0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem; border-bottom: 2px solid var(--color-dorado); padding-bottom: 0.5rem;">
                                <i class="fas fa-map-marker-alt"></i> Información de Contacto
                            </h4>
                            <div class="form-group">
                                <label><i class="fas fa-home"></i> Dirección Completa</label>
                                <textarea id="direccion" rows="2" placeholder="Ej: San José, Escazú, 200m norte de la iglesia" style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%; resize: vertical;">${cliente.direccion || ''}</textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label><i class="fas fa-phone-alt"></i> Teléfono Alternativo</label>
                                    <input type="tel" id="telefonoAlt" value="${cliente.telefonoAlt || ''}" placeholder="Opcional" style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-briefcase"></i> Empresa/Compañía</label>
                                    <input type="text" id="empresa" value="${cliente.empresa || ''}" placeholder="Opcional" style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,215,0,0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem; border-bottom: 2px solid var(--color-dorado); padding-bottom: 0.5rem;">
                                <i class="fas fa-tags"></i> Clasificación y Notas
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label><i class="fas fa-star"></i> Tipo de Cliente</label>
                                    <select id="tipoCliente" style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                        <option value="regular" ${cliente.tipoCliente === 'regular' ? 'selected' : ''}>Regular</option>
                                        <option value="vip" ${cliente.tipoCliente === 'vip' ? 'selected' : ''}>VIP</option>
                                        <option value="corporativo" ${cliente.tipoCliente === 'corporativo' ? 'selected' : ''}>Corporativo</option>
                                        <option value="nuevo" ${cliente.tipoCliente === 'nuevo' || !cliente.tipoCliente ? 'selected' : ''}>Nuevo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-percentage"></i> Descuento Especial (%)</label>
                                    <input type="number" id="descuento" value="${cliente.descuento || 0}" min="0" max="100" step="0.1" placeholder="0" style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%;">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label><i class="fas fa-sticky-note"></i> Notas Adicionales</label>
                                <textarea id="notas" rows="3" placeholder="Información adicional sobre el cliente..." style="padding: 0.75rem; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--color-texto-claro); width: 100%; resize: vertical;">${cliente.notas || ''}</textarea>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button type="button" class="btn-secondary" onclick="cerrarModal()" style="padding: 0.75rem 1.5rem;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn-primary" style="padding: 0.75rem 2rem;">
                                <i class="fas fa-save"></i> ${isEdit ? 'Actualizar' : 'Guardar'} Cliente
                            </button>
                        </div>
                        
                        <p style="margin-top: 1rem; text-align: center; opacity: 0.7; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> Los campos marcados con * son obligatorios
                        </p>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            };

            if (id) {
                DB.get('clientes', id).then(cliente => onsuccess(cliente)).catch(e => console.error("Error fetching client", e));
            } else {
                onsuccess();
            }
        };

        const guardarCliente = async (event, id) => {
            event.preventDefault();
            const data = {
                nombre: document.getElementById('nombre').value,
                cedula: document.getElementById('cedula').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                telefonoAlt: document.getElementById('telefonoAlt').value,
                empresa: document.getElementById('empresa').value,
                tipoCliente: document.getElementById('tipoCliente').value,
                descuento: parseFloat(document.getElementById('descuento').value) || 0,
                notas: document.getElementById('notas').value
            };
            if (!id) data.fechaRegistro = new Date().toISOString();

            try {
                if (id) {
                    await DB.put('clientes', id, data);
                } else {
                    await DB.add('clientes', data);
                }
                cerrarModal(); 
                cargarClientes(); 
                actualizarWidgets(); 
                actualizarActividadReciente(); 
                mostrarToast(`Cliente ${id ? 'actualizado' : 'registrado'} exitosamente`, 'success');
            } catch (error) {
                console.error('Error guardando cliente:', error);
                mostrarToast('Error al guardar el cliente', 'error');
            }
        };

        const cargarClientes = async () => {
            try {
                const clientes = await DB.getAll('clientes');
                const tbody = document.getElementById('cuerpoTablaClientes');
                tbody.innerHTML = '';
                clientes.forEach(cliente => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${cliente.id}</td>
                            <td>${cliente.nombre}</td>
                            <td>${cliente.cedula}</td>
                            <td>${cliente.email}</td>
                            <td>${cliente.telefono}</td>
                            <td>
                                <button class="btn-secondary" onclick="abrirFormularioCliente(${cliente.id})">Editar</button>
                                <button class="btn-error" onclick="eliminarCliente(${cliente.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando clientes:', error);
            }
        };

        const eliminarCliente = (id) => {
            confirmarAccion(
                'Esta acción no se puede deshacer. Se eliminará el cliente y toda su información.',
                async () => {
                    try {
                        await DB.delete('clientes', id);
                        cargarClientes(); 
                        actualizarWidgets(); 
                        actualizarActividadReciente();
                        mostrarToast('Cliente eliminado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando cliente:', error);
                        mostrarToast('Error al eliminar el cliente', 'error');
                    }
                },
                '¿Eliminar Cliente?'
            );
        };
        const buscarClientes = async () => {
            try {
                const termino = document.getElementById('buscarCliente').value.toLowerCase();
                const clientes = await DB.getAll('clientes');
                const tbody = document.getElementById('cuerpoTablaClientes');
                tbody.innerHTML = '';
                const clientesFiltrados = clientes.filter(c => 
                    c.nombre.toLowerCase().includes(termino) || 
                    c.cedula.includes(termino) || 
                    c.email.toLowerCase().includes(termino)
                );
                
                clientesFiltrados.forEach(cliente => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${cliente.id}</td>
                            <td>${cliente.nombre}</td>
                            <td>${cliente.cedula}</td>
                            <td>${cliente.email}</td>
                            <td>${cliente.telefono}</td>
                            <td>
                                <button class="btn-secondary" onclick="abrirFormularioCliente(${cliente.id})">Editar</button>
                                <button class="btn-error" onclick="eliminarCliente(${cliente.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error buscando clientes:', error);
            }
        };
        
        const buscarVouchers = async () => {
            try {
                const termino = document.getElementById('buscarVoucher').value.toLowerCase();
                const [vouchers, clientes] = await Promise.all([
                    DB.getAll('vouchers'),
                    DB.getAll('clientes')
                ]);
                
                const vouchersFiltrados = vouchers.filter(v => 
                    v.numeroComprobante.toLowerCase().includes(termino) || 
                    v.tipoComprobante.toLowerCase().includes(termino)
                );
                
                const tbody = document.getElementById('cuerpoTablaVouchers');
                tbody.innerHTML = '';
                
                vouchersFiltrados.forEach(voucher => {
                    const cliente = clientes.find(c => c.id === voucher.clienteId);
                    tbody.innerHTML += `
                        <tr>
                            <td>${voucher.id}</td>
                            <td>${cliente ? cliente.nombre : 'N/A'}</td>
                            <td>${voucher.tipoComprobante}</td>
                            <td>${voucher.numeroComprobante}</td>
                            <td>${voucher.fecha}</td>
                            <td>₡${voucher.total.toFixed(2)}</td>
                            <td><button class="btn-error" onclick="eliminarVoucher(${voucher.id})">Eliminar</button></td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error buscando vouchers:', error);
            }
        };
        const abrirFormularioVoucher = async (id = null) => {
            try {
                const clientes = await DB.getAll('clientes');
                const options = clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');

                const formHTML = `
                    <h3>Nuevo Voucher</h3>
                    <form id="formVoucher" onsubmit="guardarVoucher(event)">
                        <div class="form-group"><label>Cliente:</label><select id="clienteVoucher" required>${options}</select></div>
                        <div class="form-group"><label>Tipo:</label><input type="text" id="tipoVoucher" required></div>
                        <div class="form-group"><label>Número:</label><input type="text" id="numeroVoucher" required></div>
                        <div class="form-group"><label>Fecha:</label><input type="date" id="fechaVoucher" required></div>
                        <div class="form-group"><label>Total:</label><input type="number" id="totalVoucher" step="0.01" required></div>
                        <button type="submit" class="btn-primary">Guardar</button>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            } catch (error) {
                console.error('Error abriendo formulario voucher:', error);
                mostrarToast('Error al abrir formulario', 'error');
            }
        };

        const guardarVoucher = async (event) => {
            event.preventDefault();
            const data = {
                clienteId: parseInt(document.getElementById('clienteVoucher').value),
                tipoComprobante: document.getElementById('tipoVoucher').value,
                numeroComprobante: document.getElementById('numeroVoucher').value,
                fecha: document.getElementById('fechaVoucher').value,
                total: parseFloat(document.getElementById('totalVoucher').value),
                fechaCreacion: new Date().toISOString()
            };
            try {
                await DB.add('vouchers', data);
                cerrarModal(); cargarVouchers(); actualizarActividadReciente();
                mostrarToast('Voucher guardado exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando voucher:', error);
                mostrarToast('Error al guardar el voucher', 'error');
            }
        };

        const cargarVouchers = async () => {
            try {
                const [vouchers, clientes] = await Promise.all([
                    DB.getAll('vouchers'),
                    DB.getAll('clientes')
                ]);
                const tbody = document.getElementById('cuerpoTablaVouchers');
                tbody.innerHTML = '';
                vouchers.forEach(voucher => {
                    const cliente = clientes.find(c => c.id === voucher.clienteId);
                    tbody.innerHTML += `
                        <tr>
                            <td>${voucher.id}</td>
                            <td>${cliente ? cliente.nombre : 'N/A'}</td>
                            <td>${voucher.tipoComprobante}</td>
                            <td>${voucher.numeroComprobante}</td>
                            <td>${voucher.fecha}</td>
                            <td>₡${voucher.total.toFixed(2)}</td>
                            <td><button class="btn-error" onclick="eliminarVoucher(${voucher.id})">Eliminar</button></td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando vouchers:', error);
            }
        };
        const eliminarVoucher = (id) => {
            confirmarAccion(
                'Se eliminará este voucher permanentemente.',
                async () => {
                    try {
                        await DB.delete('vouchers', id);
                        cargarVouchers(); 
                        actualizarActividadReciente();
                        mostrarToast('Voucher eliminado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando voucher:', error);
                        mostrarToast('Error al eliminar el voucher', 'error');
                    }
                },
                '¿Eliminar Voucher?'
            );
        };
        const calcularIVA = () => {
            const montoBase = parseFloat(document.getElementById('montoBase').value) || 0;
            const tipoIVA = parseFloat(document.getElementById('tipoIVA').value);
            
            const montoIVA = montoBase * tipoIVA;
            const totalConIVA = montoBase + montoIVA;
            
            document.getElementById('montoIVA').textContent = `₡${montoIVA.toFixed(2)}`;
            document.getElementById('totalConIVA').textContent = `₡${totalConIVA.toFixed(2)}`;
        };
        
        const nuevaNota = () => {
            notaSeleccionadaId = null;
            document.getElementById('idNota').value = '';
            document.getElementById('tituloNota').value = '';
            document.getElementById('contenidoNota').value = '';
            document.getElementById('categoriaNota').value = 'general';
            document.getElementById('prioridadNota').value = 'media';
            document.getElementById('etiquetasNota').value = '';
            document.getElementById('archivarNota').checked = false;
            actualizarContadorCaracteres();
        };
        
        const guardarNota = async () => {
            const titulo = document.getElementById('tituloNota').value;
            const contenido = document.getElementById('contenidoNota').value;
            
            if (!titulo || !contenido) {
                mostrarToast('Por favor completa el título y contenido de la nota', 'warning');
                return;
            }
            
            const etiquetasArray = document.getElementById('etiquetasNota').value.split(',').map(e => e.trim()).filter(e => e);
            const data = {
                titulo: titulo,
                contenido: contenido,
                categoria: document.getElementById('categoriaNota').value,
                prioridad: document.getElementById('prioridadNota').value,
                etiquetas: JSON.stringify(etiquetasArray),
                archivada: document.getElementById('archivarNota').checked ? 1 : 0,
                fecha: new Date().toISOString(),
                fechaModificacion: new Date().toISOString(),
                caracteres: contenido.length,
                palabras: contenido.trim().split(/\s+/).length
            };
            
            try {
                if (notaSeleccionadaId) {
                    await DB.put('notas', notaSeleccionadaId, data);
                } else {
                    await DB.add('notas', data);
                }
                cargarNotas();
                mostrarToast(`Nota ${notaSeleccionadaId ? 'actualizada' : 'guardada'} exitosamente`, 'success');
            } catch (error) {
                console.error('Error guardando nota:', error);
                mostrarToast('Error al guardar la nota', 'error');
            }
        };
        
        const cargarNotas = async () => {
            try {
                const notasData = await DB.getAll('notas');
                const listaNotas = document.getElementById('listaNotas');
                listaNotas.innerHTML = '';
                
                const notasOrdenadas = notasData.sort((a, b) => new Date(b.fechaModificacion || b.fecha) - new Date(a.fechaModificacion || a.fecha));
                const busqueda = document.getElementById('buscarNota')?.value.toLowerCase() || '';
                const notasFiltradas = notasOrdenadas.filter(n => {
                    const etiquetas = typeof n.etiquetas === 'string' ? JSON.parse(n.etiquetas || '[]') : (n.etiquetas || []);
                    return !n.archivada && (
                        n.titulo.toLowerCase().includes(busqueda) || 
                        n.contenido.toLowerCase().includes(busqueda) ||
                        (etiquetas && etiquetas.some(e => e.toLowerCase().includes(busqueda)))
                    );
                });
                
                if (notasFiltradas.length === 0) {
                    listaNotas.innerHTML = '<p style="text-align: center; padding: 2rem; opacity: 0.7;">No hay notas</p>';
                    return;
                }
                
                notasFiltradas.forEach(nota => {
                    const prioridadColor = {
                        'alta': '#e74c3c',
                        'media': '#f39c12',
                        'baja': '#3498db'
                    };
                    
                    const etiquetas = typeof nota.etiquetas === 'string' ? JSON.parse(nota.etiquetas || '[]') : (nota.etiquetas || []);
                    
                    const div = document.createElement('div');
                    div.className = 'nota-item';
                    if (nota.id === notaSeleccionadaId) div.classList.add('active');
                    div.style.cssText = `border-left: 4px solid ${prioridadColor[nota.prioridad || 'media']};`;
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <h4 style="color: var(--color-dorado); margin-bottom: 0.25rem;">${nota.titulo}</h4>
                            <span style="background: ${prioridadColor[nota.prioridad || 'media']}; color: white; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">${nota.prioridad || 'media'}</span>
                        </div>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin: 0.25rem 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${nota.contenido.substring(0, 50)}...</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                            <small style="opacity: 0.7;"><i class="fas fa-clock"></i> ${new Date(nota.fechaModificacion || nota.fecha).toLocaleDateString('es-ES')}</small>
                            <div style="display: flex; gap: 0.5rem;">
                                ${etiquetas && etiquetas.length > 0 ? `<small style="background: rgba(255,215,0,0.2); padding: 0.15rem 0.5rem; border-radius: 10px;"><i class="fas fa-tag"></i> ${etiquetas[0]}</small>` : ''}
                                <button onclick="event.stopPropagation(); eliminarNota(${nota.id})" style="background: none; border: none; color: var(--color-error); cursor: pointer; padding: 0.25rem;"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    div.onclick = () => seleccionarNota(nota);
                    listaNotas.appendChild(div);
                });
                document.getElementById('totalNotas').textContent = notasData.filter(n => !n.archivada).length;
            } catch (error) {
                console.warn('Error cargando notas:', error);
            }
        };
        
        const seleccionarNota = (nota) => {
            notaSeleccionadaId = nota.id;
            document.getElementById('idNota').value = nota.id;
            document.getElementById('tituloNota').value = nota.titulo;
            document.getElementById('contenidoNota').value = nota.contenido;
            document.getElementById('categoriaNota').value = nota.categoria || 'general';
            document.getElementById('prioridadNota').value = nota.prioridad || 'media';
            const etiquetas = typeof nota.etiquetas === 'string' ? JSON.parse(nota.etiquetas || '[]') : (nota.etiquetas || []);
            document.getElementById('etiquetasNota').value = etiquetas.join(', ');
            document.getElementById('archivarNota').checked = nota.archivada == 1 || nota.archivada === true;
            actualizarContadorCaracteres();
            cargarNotas();
        };
        
        const eliminarNota = (id) => {
            confirmarAccion(
                'Esta nota se eliminará permanentemente.',
                async () => {
                    try {
                        await DB.delete('notas', id);
                        if (notaSeleccionadaId === id) nuevaNota();
                        cargarNotas();
                        mostrarToast('Nota eliminada exitosamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando nota:', error);
                        mostrarToast('Error al eliminar la nota', 'error');
                    }
                },
                '¿Eliminar Nota?'
            );
        };
        
        const buscarNotas = () => {
            cargarNotas();
        };
        
        const actualizarContadorCaracteres = () => {
            const contenido = document.getElementById('contenidoNota').value;
            const caracteres = contenido.length;
            const palabras = contenido.trim().split(/\s+/).filter(p => p).length;
            const contador = document.getElementById('contadorCaracteres');
            if (contador) {
                contador.textContent = `${caracteres} caracteres | ${palabras} palabras`;
            }
        };
        
        const exportarNotasPDF = async () => {
            try {
                const notasData = await DB.getAll('notas');
                const notas = notasData.filter(n => !n.archivada);
                if (notas.length === 0) {
                    mostrarToast('No hay notas para exportar', 'warning');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text('Bloc de Notas - AJHB', 20, 20);
                doc.setFontSize(10);
                doc.text(`Generado: ${new Date().toLocaleDateString('es-ES')}`, 20, 28);
                
                let y = 40;
                notas.forEach((nota, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${nota.titulo}`, 20, y);
                    y += 7;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Fecha: ${new Date(nota.fecha).toLocaleDateString('es-ES')} | Prioridad: ${nota.prioridad || 'media'}`, 20, y);
                    y += 7;
                    
                    const lineas = doc.splitTextToSize(nota.contenido, 170);
                    lineas.forEach(linea => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(linea, 20, y);
                        y += 5;
                    });
                    
                    y += 5;
                });
                
                doc.save('notas-ajhb.pdf');
                mostrarToast('PDF exportado exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando PDF:', error);
                mostrarToast('Error al exportar PDF', 'error');
            }
        };
        
        const inicializarCalendario = () => {
            calendarioFechaActual = new Date();
            actualizarCalendario();
        };
        
        const cambiarMes = (direccion) => {
            calendarioFechaActual.setMonth(calendarioFechaActual.getMonth() + direccion);
            actualizarCalendario();
        };
        
        const actualizarCalendario = async () => {
            try {
                const mesActual = document.getElementById('mesActual');
                mesActual.textContent = calendarioFechaActual.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                
                const grid = document.getElementById('calendarioGrid');
                grid.innerHTML = '';
                
                const primerDia = new Date(calendarioFechaActual.getFullYear(), calendarioFechaActual.getMonth(), 1);
                const ultimoDia = new Date(calendarioFechaActual.getFullYear(), calendarioFechaActual.getMonth() + 1, 0);
                
                const [eventos, cxc, cxp] = await Promise.all([
                    DB.getAll('eventos'),
                    DB.getAll('cuentasPorCobrar'),
                    DB.getAll('cuentasPorPagar')
                ]);
                
                {
                const eventosPorDia = {};
                
                eventos.forEach(e => {
                    const fecha = new Date(e.fecha);
                    if (fecha.getMonth() === calendarioFechaActual.getMonth() && fecha.getFullYear() === calendarioFechaActual.getFullYear()) {
                        const dia = fecha.getDate();
                        if (!eventosPorDia[dia]) eventosPorDia[dia] = [];
                        eventosPorDia[dia].push({ tipo: 'evento', titulo: e.titulo, color: '#3498db' });
                    }
                });
                cxc.filter(c => c.estado !== 'pagada').forEach(c => {
                    const fecha = new Date(c.fechaVencimiento);
                    if (fecha.getMonth() === calendarioFechaActual.getMonth() && fecha.getFullYear() === calendarioFechaActual.getFullYear()) {
                        const dia = fecha.getDate();
                        if (!eventosPorDia[dia]) eventosPorDia[dia] = [];
                        eventosPorDia[dia].push({ tipo: 'cobrar', titulo: `Vence CxC #${c.numeroFactura}`, color: '#4CAF50' });
                    }
                });
                cxp.filter(c => c.estado !== 'pagada').forEach(c => {
                    const fecha = new Date(c.fechaVencimiento);
                    if (fecha.getMonth() === calendarioFechaActual.getMonth() && fecha.getFullYear() === calendarioFechaActual.getFullYear()) {
                        const dia = fecha.getDate();
                        if (!eventosPorDia[dia]) eventosPorDia[dia] = [];
                        eventosPorDia[dia].push({ tipo: 'pagar', titulo: `Vence CxP #${c.numeroFactura}`, color: '#e74c3c' });
                    }
                });
                const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                diasSemana.forEach(dia => {
                    const diaHeader = document.createElement('div');
                    diaHeader.style.cssText = 'padding: 0.5rem; text-align: center; font-weight: bold; color: var(--color-dorado); border: 1px solid #333;';
                    diaHeader.textContent = dia;
                    grid.appendChild(diaHeader);
                });
                for (let i = 0; i < primerDia.getDay(); i++) {
                    const vacio = document.createElement('div');
                    vacio.style.cssText = 'padding: 1rem; border: 1px solid #333; min-height: 80px;';
                    grid.appendChild(vacio);
                }
                const hoy = new Date();
                for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                    const diaDiv = document.createElement('div');
                    const esHoy = hoy.getDate() === dia && hoy.getMonth() === calendarioFechaActual.getMonth() && hoy.getFullYear() === calendarioFechaActual.getFullYear();
                    
                    diaDiv.style.cssText = `
                        padding: 0.5rem; 
                        border: 1px solid #333; 
                        cursor: pointer; 
                        transition: background 0.3s;
                        min-height: 80px;
                        ${esHoy ? 'background: rgba(255, 215, 0, 0.15); border-color: var(--color-dorado);' : ''}
                    `;
                    
                    diaDiv.innerHTML = `<div style="font-weight: bold; margin-bottom: 0.25rem; ${esHoy ? 'color: var(--color-dorado);' : ''}">${dia}</div>`;
                    if (eventosPorDia[dia]) {
                        eventosPorDia[dia].slice(0, 3).forEach(evento => {
                            const eventoEl = document.createElement('div');
                            eventoEl.style.cssText = `
                                font-size: 0.7rem; 
                                padding: 0.15rem 0.25rem; 
                                margin-bottom: 0.15rem; 
                                background: ${evento.color}; 
                                border-radius: 3px;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            `;
                            eventoEl.textContent = evento.titulo;
                            eventoEl.title = evento.titulo;
                            diaDiv.appendChild(eventoEl);
                        });
                        
                        if (eventosPorDia[dia].length > 3) {
                            const masEl = document.createElement('div');
                            masEl.style.cssText = 'font-size: 0.7rem; color: var(--color-dorado); margin-top: 0.15rem;';
                            masEl.textContent = `+${eventosPorDia[dia].length - 3} más`;
                            diaDiv.appendChild(masEl);
                        }
                    }
                    
                    diaDiv.onclick = () => mostrarEventosDia(dia, eventosPorDia[dia] || []);
                    diaDiv.onmouseover = () => {
                        if (!esHoy) diaDiv.style.background = 'rgba(255, 215, 0, 0.1)';
                    };
                    diaDiv.onmouseout = () => {
                        if (!esHoy) diaDiv.style.background = 'transparent';
                    };
                    
                    grid.appendChild(diaDiv);
                }
                
                grid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 0; margin-top: 1rem;';
                }
            } catch (error) {
                console.error('Error actualizando calendario:', error);
            }
        };
        
        const mostrarEventosDia = (dia, eventos) => {
            const fecha = new Date(calendarioFechaActual.getFullYear(), calendarioFechaActual.getMonth(), dia);
            const contenedor = document.getElementById('eventosDia');
            
            if (eventos.length === 0) {
                contenedor.innerHTML = `
                    <h4 style="color: var(--color-dorado);">Eventos del ${fecha.toLocaleDateString('es-ES')}</h4>
                    <p style="opacity: 0.7;">No hay eventos programados para este día</p>
                `;
            } else {
                let html = `<h4 style="color: var(--color-dorado);">Eventos del ${fecha.toLocaleDateString('es-ES')}</h4>`;
                eventos.forEach(e => {
                    html += `
                        <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,215,0,0.05); border-left: 4px solid ${e.color}; border-radius: 4px;">
                            <strong>${e.titulo}</strong>
                            <span style="margin-left: 0.5rem; opacity: 0.7;">(${e.tipo})</span>
                        </div>
                    `;
                });
                contenedor.innerHTML = html;
            }
        };
        const abrirFormularioEvento = () => {
            const formHTML = `
                <h3>Nuevo Evento</h3>
                <form id="formEvento" onsubmit="guardarEvento(event)">
                    <div class="form-group"><label>Título:</label><input type="text" id="tituloEvento" required></div>
                    <div class="form-group"><label>Fecha:</label><input type="date" id="fechaEvento" required></div>
                    <div class="form-group"><label>Hora:</label><input type="time" id="horaEvento" required></div>
                    <div class="form-group"><label>Tipo:</label><select id="tipoEvento"><option value="reunion">Reunión</option><option value="tarea">Tarea</option><option value="recordatorio">Recordatorio</option></select></div>
                    <div class="form-group"><label>Descripción:</label><textarea id="descripcionEvento" rows="3"></textarea></div>
                    <button type="submit" class="btn-primary">Guardar Evento</button>
                </form>
            `;
            abrirModalConContenido(formHTML);
        };
        
        const guardarEvento = async (event) => {
            event.preventDefault();
            const data = {
                titulo: document.getElementById('tituloEvento').value,
                fecha: document.getElementById('fechaEvento').value,
                hora: document.getElementById('horaEvento').value,
                tipo: document.getElementById('tipoEvento').value,
                descripcion: document.getElementById('descripcionEvento').value || '',
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                await DB.add('eventos', data);
                cerrarModal();
                actualizarWidgets();
                actualizarCalendario();
                mostrarToast('Evento guardado exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando evento:', error);
                mostrarToast('Error al guardar el evento', 'error');
            }
        };
        
        const generarReporte = async (tipo) => {
            const contenedor = document.getElementById('contenedorReporte');
            contenedor.classList.remove('hidden');
            contenedor.innerHTML = '<p>Generando reporte...</p>';
            const btnExportar = document.getElementById('btnExportarReporte');
            if (btnExportar) {
                btnExportar.style.display = 'block';
                btnExportar.onclick = () => exportarReportePDF(tipo);
            }
            
            try {
                switch(tipo) {
                    case 'balance':
                        await generarBalanceGeneral(contenedor);
                        break;
                    case 'resultados':
                        await generarEstadoResultados(contenedor);
                        break;
                    case 'flujo':
                        await generarFlujoCaja(contenedor);
                        break;
                    case 'mayor':
                        await generarLibroMayor(contenedor);
                        break;
                    case 'diario':
                        await generarLibroDiario(contenedor);
                        break;
                    case 'balanceComprobacion':
                        await generarBalanceComprobacion(contenedor);
                        break;
                }
            } catch (error) {
                console.error('Error generando reporte:', error);
                contenedor.innerHTML = '<p style="color: red;">Error al generar el reporte. Por favor, intenta de nuevo.</p>';
            }
        };

        const generarBalanceGeneral = async (contenedor) => {
            const [bancos, activos, cxc, cxp] = await Promise.all([
                DB.getAll('bancos'),
                DB.getAll('activos'),
                DB.getAll('cuentasPorCobrar'),
                DB.getAll('cuentasPorPagar')
            ]);
            
            const saldoBancos = bancos.reduce((s, b) => s + b.saldo, 0);
            const cuentasCobrar = cxc.filter(c => c.estado !== 'pagada').reduce((s, c) => s + c.saldo, 0);
            const valorActivos = activos.reduce((s, a) => s + a.valorEnLibros, 0);
            const activoCorriente = saldoBancos + cuentasCobrar;
            const activoNoCorriente = valorActivos;
            const totalActivos = activoCorriente + activoNoCorriente;
            
            const cuentasPagar = cxp.filter(c => c.estado !== 'pagada').reduce((s, c) => s + c.saldo, 0);
            const pasivoCorriente = cuentasPagar;
            const pasivoNoCorriente = 0;
            const totalPasivos = pasivoCorriente + pasivoNoCorriente;
            const patrimonio = totalActivos - totalPasivos;
                
                contenedor.innerHTML = `
                    <h3><i class="fas fa-balance-scale-right"></i> Balance General</h3>
                    <p style="margin: 1rem 0;"><strong>AJHB Bienes Raíces</strong></p>
                    <p style="margin-bottom: 1rem;">Al ${new Date().toLocaleDateString('es-ES')}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">ACTIVOS</h4>
                            <p><strong>Activo Corriente:</strong></p>
                            <p style="margin-left: 1rem;">Bancos: ₡${saldoBancos.toFixed(2)}</p>
                            <p style="margin-left: 1rem;">Cuentas por Cobrar: ₡${cuentasCobrar.toFixed(2)}</p>
                            <p style="margin-left: 1rem; font-weight: bold;">Total Corriente: ₡${activoCorriente.toFixed(2)}</p>
                            <p style="margin-top: 1rem;"><strong>Activo No Corriente:</strong></p>
                            <p style="margin-left: 1rem;">Activos Fijos: ₡${valorActivos.toFixed(2)}</p>
                            <p style="margin-left: 1rem; font-weight: bold;">Total No Corriente: ₡${activoNoCorriente.toFixed(2)}</p>
                            <p style="font-weight: bold; margin-top: 1rem; color: var(--color-dorado); font-size: 1.2rem;">TOTAL ACTIVOS: ₡${totalActivos.toFixed(2)}</p>
                        </div>
                        <div>
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">PASIVOS Y PATRIMONIO</h4>
                            <p><strong>Pasivo Corriente:</strong></p>
                            <p style="margin-left: 1rem;">Cuentas por Pagar: ₡${cuentasPagar.toFixed(2)}</p>
                            <p style="margin-left: 1rem; font-weight: bold;">Total Corriente: ₡${pasivoCorriente.toFixed(2)}</p>
                            <p style="margin-top: 1rem;"><strong>Pasivo No Corriente:</strong></p>
                            <p style="margin-left: 1rem;">Préstamos LP: ₡${pasivoNoCorriente.toFixed(2)}</p>
                            <p style="margin-left: 1rem; font-weight: bold;">Total No Corriente: ₡${pasivoNoCorriente.toFixed(2)}</p>
                            <p style="font-weight: bold; margin-top: 1rem;">TOTAL PASIVOS: ₡${totalPasivos.toFixed(2)}</p>
                            <p style="margin-top: 1rem;"><strong>PATRIMONIO:</strong></p>
                            <p style="margin-left: 1rem;">Capital: ₡${patrimonio.toFixed(2)}</p>
                            <p style="font-weight: bold; margin-top: 1rem; color: var(--color-dorado); font-size: 1.2rem;">TOTAL PASIVO + PATRIMONIO: ₡${(totalPasivos + patrimonio).toFixed(2)}</p>
                        </div>
                    </div>
                `;
        };

        const generarEstadoResultados = async (contenedor) => {
            const [cuentas, detalles] = await Promise.all([
                DB.getAll('cuentas'),
                DB.getAll('detallesAsiento')
            ]);
            
            const cuentasIngresos = cuentas.filter(c => c.tipo === 'ingreso');
            const cuentasGastos = cuentas.filter(c => c.tipo === 'gasto');
            
            let totalIngresos = 0;
            let totalGastos = 0;
            
            detalles.forEach(d => {
                const cuenta = cuentas.find(c => c.id === d.cuentaId);
                if (cuenta) {
                    if (cuenta.tipo === 'ingreso') totalIngresos += d.haber - d.debe;
                    if (cuenta.tipo === 'gasto') totalGastos += d.debe - d.haber;
                }
            });
            
            const utilidadNeta = totalIngresos - totalGastos;
                
                contenedor.innerHTML = `
                    <h3><i class="fas fa-chart-bar"></i> Estado de Resultados</h3>
                    <p style="margin: 1rem 0;"><strong>AJHB Bienes Raíces</strong></p>
                    <p style="margin-bottom: 1rem;">Del 01/01/${new Date().getFullYear()} al ${new Date().toLocaleDateString('es-ES')}</p>
                    <div>
                        <h4 style="color: var(--color-dorado); margin: 1rem 0;">INGRESOS</h4>
                        <p style="margin-left: 1rem;">Ingresos Operacionales: ₡${totalIngresos.toFixed(2)}</p>
                        <p style="font-weight: bold; color: var(--color-exito); margin-left: 1rem;">Total Ingresos: ₡${totalIngresos.toFixed(2)}</p>
                        
                        <h4 style="color: var(--color-dorado); margin: 1rem 0;">GASTOS</h4>
                        <p style="margin-left: 1rem;">Gastos Operativos: ₡${totalGastos.toFixed(2)}</p>
                        <p style="font-weight: bold; color: var(--color-error); margin-left: 1rem;">Total Gastos: ₡${totalGastos.toFixed(2)}</p>
                        
                        <h4 style="color: var(--color-dorado); margin: 1.5rem 0; padding-top: 1rem; border-top: 2px solid var(--color-dorado); font-size: 1.3rem;">
                            UTILIDAD NETA: <span style="color: ${utilidadNeta >= 0 ? 'var(--color-exito)' : 'var(--color-error)'};">₡${utilidadNeta.toFixed(2)}</span>
                        </h4>
                    </div>
                `;
        };

        const generarFlujoCaja = async (contenedor) => {
            const [movimientos, activos, cxc, cxp, bancos] = await Promise.all([
                DB.getAll('movimientosBancarios'),
                DB.getAll('activos'),
                DB.getAll('cuentasPorCobrar'),
                DB.getAll('cuentasPorPagar'),
                DB.getAll('bancos')
            ]);
            
            const cobrosClientes = cxc.filter(c => c.estado === 'pagada').reduce((s, c) => s + c.monto, 0);
            const pagosProveedores = cxp.filter(c => c.estado === 'pagada').reduce((s, c) => s + c.monto, 0);
            const ingresosEfectivo = movimientos.filter(m => m.tipo === 'ingreso').reduce((s, m) => s + m.monto, 0);
            const egresosEfectivo = movimientos.filter(m => m.tipo === 'egreso').reduce((s, m) => s + m.monto, 0);
            
            const totalCobros = cobrosClientes + ingresosEfectivo;
            const totalPagos = pagosProveedores + egresosEfectivo;
            const flujoOperativo = totalCobros - totalPagos;
            const compraActivos = activos.reduce((s, a) => s + a.valorCompra, 0);
            const ventaActivos = 0;
            const flujoInversion = ventaActivos - compraActivos;
                const prestamosRecibidos = 0;
                const pagosPrestamos = 0;
                const aportesCapital = 0;
                const flujoFinanciamiento = prestamosRecibidos - pagosPrestamos + aportesCapital;
                const flujoNeto = flujoOperativo + flujoInversion + flujoFinanciamiento;
                const saldoInicial = 0;
                const saldoFinal = bancos.reduce((s, b) => s + b.saldo, 0);
                const movimientosDetalle = movimientos.slice(0, 10).map(m => ({
                    fecha: m.fecha,
                    tipo: m.tipo,
                    descripcion: m.descripcion,
                    monto: m.monto
                }));
                
                contenedor.innerHTML = `
                    <h3><i class="fas fa-cash-register"></i> Estado de Flujo de Efectivo</h3>
                    <p style="margin: 1rem 0;"><strong>AJHB Bienes Raíces</strong></p>
                    <p style="margin-bottom: 1rem;">Del 01/01/${new Date().getFullYear()} al ${new Date().toLocaleDateString('es-ES')}</p>
                    
                    <div style="background: rgba(255,215,0,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p><strong>Saldo Inicial de Efectivo:</strong> ₡${saldoInicial.toFixed(2)}</p>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--color-dorado); margin: 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-dorado);">
                            <i class="fas fa-chart-line"></i> ACTIVIDADES OPERATIVAS
                        </h4>
                        <div style="margin-left: 1.5rem;">
                            <p style="margin: 0.5rem 0;"><strong>Entradas de Efectivo:</strong></p>
                            <p style="margin-left: 1rem;">• Cobros a Clientes: <span style="color: var(--color-exito);">₡${cobrosClientes.toFixed(2)}</span></p>
                            <p style="margin-left: 1rem;">• Otros Ingresos: <span style="color: var(--color-exito);">₡${ingresosEfectivo.toFixed(2)}</span></p>
                            <p style="margin-left: 1rem; font-weight: bold;">Total Entradas: ₡${totalCobros.toFixed(2)}</p>
                            
                            <p style="margin: 0.5rem 0; margin-top: 1rem;"><strong>Salidas de Efectivo:</strong></p>
                            <p style="margin-left: 1rem;">• Pagos a Proveedores: <span style="color: var(--color-error);">₡${pagosProveedores.toFixed(2)}</span></p>
                            <p style="margin-left: 1rem;">• Otros Egresos: <span style="color: var(--color-error);">₡${egresosEfectivo.toFixed(2)}</span></p>
                            <p style="margin-left: 1rem; font-weight: bold;">Total Salidas: ₡${totalPagos.toFixed(2)}</p>
                        </div>
                        <p style="font-weight: bold; margin: 1rem 0; padding: 0.75rem; background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50;">
                            Flujo Neto de Actividades Operativas: <span style="color: ${flujoOperativo >= 0 ? 'var(--color-exito)' : 'var(--color-error)'};">₡${flujoOperativo.toFixed(2)}</span>
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--color-dorado); margin: 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-dorado);">
                            <i class="fas fa-building"></i> ACTIVIDADES DE INVERSIÓN
                        </h4>
                        <div style="margin-left: 1.5rem;">
                            <p style="margin: 0.5rem 0;">• Compra de Activos Fijos: <span style="color: var(--color-error);">₡${compraActivos.toFixed(2)}</span></p>
                            <p style="margin: 0.5rem 0;">• Venta de Activos Fijos: <span style="color: var(--color-exito);">₡${ventaActivos.toFixed(2)}</span></p>
                            <p style="margin: 0.5rem 0; opacity: 0.7; font-size: 0.9rem;">Total Activos Registrados: ${activos.length}</p>
                        </div>
                        <p style="font-weight: bold; margin: 1rem 0; padding: 0.75rem; background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3;">
                            Flujo Neto de Actividades de Inversión: <span style="color: ${flujoInversion >= 0 ? 'var(--color-exito)' : 'var(--color-error)'};">₡${flujoInversion.toFixed(2)}</span>
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--color-dorado); margin: 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-dorado);">
                            <i class="fas fa-hand-holding-usd"></i> ACTIVIDADES DE FINANCIAMIENTO
                        </h4>
                        <div style="margin-left: 1.5rem;">
                            <p style="margin: 0.5rem 0;">• Préstamos Recibidos: <span style="color: var(--color-exito);">₡${prestamosRecibidos.toFixed(2)}</span></p>
                            <p style="margin: 0.5rem 0;">• Pago de Préstamos: <span style="color: var(--color-error);">₡${pagosPrestamos.toFixed(2)}</span></p>
                            <p style="margin: 0.5rem 0;">• Aportes de Capital: <span style="color: var(--color-exito);">₡${aportesCapital.toFixed(2)}</span></p>
                        </div>
                        <p style="font-weight: bold; margin: 1rem 0; padding: 0.75rem; background: rgba(156, 39, 176, 0.1); border-left: 4px solid #9C27B0;">
                            Flujo Neto de Actividades de Financiamiento: <span style="color: ${flujoFinanciamiento >= 0 ? 'var(--color-exito)' : 'var(--color-error)'};">₡${flujoFinanciamiento.toFixed(2)}</span>
                        </p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05)); padding: 1.5rem; border-radius: 8px; border: 2px solid var(--color-dorado);">
                        <h4 style="color: var(--color-dorado); margin-bottom: 1rem; font-size: 1.3rem;">
                            <i class="fas fa-chart-pie"></i> RESUMEN DEL FLUJO
                        </h4>
                        <p style="font-size: 1.1rem; margin: 0.5rem 0;">Aumento/Disminución Neta en Efectivo: <strong style="color: ${flujoNeto >= 0 ? 'var(--color-exito)' : 'var(--color-error)'};">₡${flujoNeto.toFixed(2)}</strong></p>
                        <p style="font-size: 1.1rem; margin: 0.5rem 0;">Saldo Inicial de Efectivo: <strong>₡${saldoInicial.toFixed(2)}</strong></p>
                        <hr style="margin: 1rem 0; border-color: var(--color-dorado);">
                        <p style="font-size: 1.3rem; font-weight: bold; color: var(--color-dorado);">
                            Saldo Final de Efectivo: ₡${saldoFinal.toFixed(2)}
                        </p>
                        <p style="margin-top: 0.5rem; opacity: 0.8; font-size: 0.9rem;">
                            <i class="fas fa-university"></i> Distribuido en ${bancos.length} cuenta(s) bancaria(s)
                        </p>
                    </div>
                    
                    ${movimientosDetalle.length > 0 ? `
                        <div style="margin-top: 2rem;">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">
                                <i class="fas fa-list"></i> Últimos Movimientos Registrados
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${movimientosDetalle.map(m => `
                                    <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,215,0,0.05); border-left: 3px solid ${m.tipo === 'ingreso' ? '#4CAF50' : '#e74c3c'}; border-radius: 4px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${m.descripcion}</strong>
                                                <br><small style="opacity: 0.7;">${m.fecha}</small>
                                            </div>
                                            <div style="text-align: right;">
                                                <strong style="color: ${m.tipo === 'ingreso' ? 'var(--color-exito)' : 'var(--color-error)'}; font-size: 1.1rem;">
                                                    ${m.tipo === 'ingreso' ? '+' : '-'}₡${m.monto.toFixed(2)}
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<p style="text-align: center; padding: 2rem; opacity: 0.7;">No hay movimientos bancarios registrados aún</p>'}
                `;
        };

        const generarLibroMayor = async (contenedor) => {
            const [cuentas, detalles, asientos] = await Promise.all([
                DB.getAll('cuentas'),
                DB.getAll('detallesAsiento'),
                DB.getAll('asientos')
            ]);
            
            let html = `
                    <h3><i class="fas fa-book-open"></i> Libro Mayor</h3>
                    <p style="margin-bottom: 1rem;">Período: ${new Date().getFullYear()}</p>
                `;
                
                cuentas.filter(c => c.categoria === 'detalle').forEach(cuenta => {
                    const movimientos = detalles.filter(d => d.cuentaId === cuenta.id);
                    if (movimientos.length > 0) {
                        let saldo = 0;
                        html += `
                            <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,215,0,0.05); border-radius: 8px;">
                                <h4 style="color: var(--color-dorado);">${cuenta.codigo} - ${cuenta.nombre}</h4>
                                <table style="width: 100%; margin-top: 0.5rem;">
                                    <thead><tr><th>Fecha</th><th>Descripción</th><th>Debe</th><th>Haber</th><th>Saldo</th></tr></thead>
                                    <tbody>
                        `;
                        
                        movimientos.forEach(mov => {
                            const asiento = asientos.find(a => a.id === mov.asientoId);
                            if (asiento) {
                                saldo += mov.debe - mov.haber;
                                html += `
                                    <tr>
                                        <td>${asiento.fecha}</td>
                                        <td>${asiento.descripcion}</td>
                                        <td>₡${mov.debe.toFixed(2)}</td>
                                        <td>₡${mov.haber.toFixed(2)}</td>
                                        <td>₡${saldo.toFixed(2)}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        html += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="font-weight: bold; background: rgba(255,215,0,0.1);">
                                            <td colspan="4">Saldo Final</td>
                                            <td>₡${saldo.toFixed(2)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                    }
                });
                
            contenedor.innerHTML = html;
        };

        const generarLibroDiario = async (contenedor) => {
            const [asientos, detalles, cuentas] = await Promise.all([
                DB.getAll('asientos'),
                DB.getAll('detallesAsiento'),
                DB.getAll('cuentas')
            ]);
            
            asientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                const totalDebeGeneral = asientos.reduce((s, a) => s + a.totalDebe, 0);
                const totalHaberGeneral = asientos.reduce((s, a) => s + a.totalHaber, 0);
                const diferencia = Math.abs(totalDebeGeneral - totalHaberGeneral);
                const estaCuadrado = diferencia < 0.01;
                const asientosPorMes = {};
                asientos.forEach(a => {
                    const fecha = new Date(a.fecha);
                    const mes = fecha.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    if (!asientosPorMes[mes]) asientosPorMes[mes] = [];
                    asientosPorMes[mes].push(a);
                });
                
                let html = `
                    <h3><i class="fas fa-journal-whills"></i> Libro Diario General</h3>
                    <p style="margin: 1rem 0;"><strong>AJHB Bienes Raíces</strong></p>
                    <p style="margin-bottom: 1rem;">Período: ${new Date().getFullYear()}</p>
                    
                    <div style="background: ${estaCuadrado ? 'rgba(76, 175, 80, 0.1)' : 'rgba(231, 76, 60, 0.1)'}; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid ${estaCuadrado ? '#4CAF50' : '#e74c3c'};">
                        <h4 style="color: var(--color-dorado); margin-bottom: 0.5rem;">Resumen del Período</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div>
                                <p style="opacity: 0.8;">Total Asientos:</p>
                                <p style="font-size: 1.5rem; font-weight: bold;">${asientos.length}</p>
                            </div>
                            <div>
                                <p style="opacity: 0.8;">Total Debe:</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--color-exito);">₡${totalDebeGeneral.toFixed(2)}</p>
                            </div>
                            <div>
                                <p style="opacity: 0.8;">Total Haber:</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--color-exito);">₡${totalHaberGeneral.toFixed(2)}</p>
                            </div>
                        </div>
                        <p style="margin-top: 1rem; font-weight: bold; color: ${estaCuadrado ? '#4CAF50' : '#e74c3c'};">
                            ${estaCuadrado ? '✓ Libro Diario Cuadrado' : '⚠ Diferencia: ₡' + diferencia.toFixed(2)}
                        </p>
                    </div>
                `;
                
                if (asientos.length === 0) {
                    html += '<p style="text-align: center; padding: 3rem; opacity: 0.7;">No hay asientos contables registrados aún</p>';
                } else {
                    Object.keys(asientosPorMes).forEach(mes => {
                        const asientosMes = asientosPorMes[mes];
                        const totalDebeMes = asientosMes.reduce((s, a) => s + a.totalDebe, 0);
                        const totalHaberMes = asientosMes.reduce((s, a) => s + a.totalHaber, 0);
                        
                        html += `
                            <div style="margin-bottom: 3rem;">
                                <h4 style="color: var(--color-dorado); padding: 0.75rem; background: rgba(255,215,0,0.1); border-left: 4px solid var(--color-dorado); margin-bottom: 1rem;">
                                    <i class="fas fa-calendar-alt"></i> ${mes.toUpperCase()} - ${asientosMes.length} Asiento(s)
                                </h4>
                        `;
                        
                        asientosMes.forEach((asiento, index) => {
                            const movimientos = detalles.filter(d => d.asientoId === asiento.id);
                            const tipoColor = {
                                'diario': '#3498db',
                                'ajuste': '#f39c12',
                                'cierre': '#e74c3c'
                            };
                            
                            html += `
                                <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(255,215,0,0.05); border-radius: 8px; border: 1px solid rgba(255,215,0,0.2); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--color-dorado);">
                                        <div>
                                            <h5 style="color: var(--color-dorado); font-size: 1.2rem; margin-bottom: 0.25rem;">
                                                <i class="fas fa-file-alt"></i> Asiento N° ${asiento.numero}
                                            </h5>
                                            <p style="opacity: 0.8; margin: 0.25rem 0;">
                                                <i class="fas fa-calendar"></i> ${new Date(asiento.fecha).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                            </p>
                                            <p style="margin: 0.5rem 0; font-style: italic; opacity: 0.9;">
                                                <i class="fas fa-comment-alt"></i> ${asiento.descripcion}
                                            </p>
                                        </div>
                                        <div style="text-align: right;">
                                            <span style="background: ${tipoColor[asiento.tipo] || '#666'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold;">
                                                ${asiento.tipo.toUpperCase()}
                                            </span>
                                            <p style="margin-top: 0.5rem; opacity: 0.7; font-size: 0.9rem;">
                                                Estado: <span style="color: ${asiento.estado === 'activo' ? 'var(--color-exito)' : 'var(--color-error)'};">${asiento.estado}</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                                        <thead>
                                            <tr style="background: rgba(255,215,0,0.15);">
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--color-dorado);">Código</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--color-dorado);">Cuenta</th>
                                                <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid var(--color-dorado);">Debe</th>
                                                <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid var(--color-dorado);">Haber</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            const movimientosDebe = movimientos.filter(m => m.debe > 0);
                            const movimientosHaber = movimientos.filter(m => m.haber > 0);
                            movimientosDebe.forEach(mov => {
                                const cuenta = cuentas.find(c => c.id === mov.cuentaId);
                                if (cuenta) {
                                    html += `
                                        <tr style="border-bottom: 1px solid rgba(255,215,0,0.1);">
                                            <td style="padding: 0.75rem; font-family: monospace;">${cuenta.codigo}</td>
                                            <td style="padding: 0.75rem; font-weight: 500;">${cuenta.nombre}</td>
                                            <td style="padding: 0.75rem; text-align: right; color: var(--color-exito); font-weight: bold;">₡${mov.debe.toFixed(2)}</td>
                                            <td style="padding: 0.75rem; text-align: right;">-</td>
                                        </tr>
                                    `;
                                }
                            });
                            movimientosHaber.forEach(mov => {
                                const cuenta = cuentas.find(c => c.id === mov.cuentaId);
                                if (cuenta) {
                                    html += `
                                        <tr style="border-bottom: 1px solid rgba(255,215,0,0.1);">
                                            <td style="padding: 0.75rem; padding-left: 2rem; font-family: monospace;">${cuenta.codigo}</td>
                                            <td style="padding: 0.75rem; padding-left: 2rem; font-weight: 500;">${cuenta.nombre}</td>
                                            <td style="padding: 0.75rem; text-align: right;">-</td>
                                            <td style="padding: 0.75rem; text-align: right; color: var(--color-error); font-weight: bold;">₡${mov.haber.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                            });
                            
                            html += `
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05)); font-weight: bold;">
                                                <td colspan="2" style="padding: 1rem; border-top: 2px solid var(--color-dorado);">
                                                    <i class="fas fa-calculator"></i> TOTALES DEL ASIENTO
                                                </td>
                                                <td style="padding: 1rem; text-align: right; border-top: 2px solid var(--color-dorado); color: var(--color-exito); font-size: 1.1rem;">₡${asiento.totalDebe.toFixed(2)}</td>
                                                <td style="padding: 1rem; text-align: right; border-top: 2px solid var(--color-dorado); color: var(--color-error); font-size: 1.1rem;">₡${asiento.totalHaber.toFixed(2)}</td>
                                            </tr>
                                            <tr>
                                                <td colspan="4" style="padding: 0.5rem; text-align: center; font-size: 0.9rem;">
                                                    ${Math.abs(asiento.totalDebe - asiento.totalHaber) < 0.01 
                                                        ? '<span style="color: var(--color-exito);"><i class="fas fa-check-circle"></i> Asiento Cuadrado</span>' 
                                                        : '<span style="color: var(--color-error);"><i class="fas fa-exclamation-triangle"></i> Asiento Descuadrado</span>'}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        });
                        
                        html += `
                                <div style="padding: 1rem; background: rgba(255,215,0,0.1); border-radius: 8px; margin-top: 1rem;">
                                    <p style="font-weight: bold; color: var(--color-dorado);">Totales del Mes:</p>
                                    <div style="display: flex; justify-content: space-around; margin-top: 0.5rem;">
                                        <p>Debe: <strong style="color: var(--color-exito);">₡${totalDebeMes.toFixed(2)}</strong></p>
                                        <p>Haber: <strong style="color: var(--color-error);">₡${totalHaberMes.toFixed(2)}</strong></p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
            contenedor.innerHTML = html;
        };

        const generarBalanceComprobacion = async (contenedor) => {
            const [cuentas, detalles] = await Promise.all([
                DB.getAll('cuentas'),
                DB.getAll('detallesAsiento')
            ]);
            
            let html = `
                    <h3><i class="fas fa-clipboard-check"></i> Balance de Comprobación</h3>
                    <p style="margin-bottom: 1rem;">Al ${new Date().toLocaleDateString('es-ES')}</p>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Cuenta</th>
                                <th>Debe</th>
                                <th>Haber</th>
                                <th>Saldo Deudor</th>
                                <th>Saldo Acreedor</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let totalDebe = 0, totalHaber = 0, totalDeudor = 0, totalAcreedor = 0;
                
                cuentas.filter(c => c.categoria === 'detalle').forEach(cuenta => {
                    const movimientos = detalles.filter(d => d.cuentaId === cuenta.id);
                    const debe = movimientos.reduce((s, m) => s + m.debe, 0);
                    const haber = movimientos.reduce((s, m) => s + m.haber, 0);
                    const saldo = debe - haber;
                    
                    if (debe > 0 || haber > 0) {
                        totalDebe += debe;
                        totalHaber += haber;
                        
                        html += `
                            <tr>
                                <td>${cuenta.codigo}</td>
                                <td>${cuenta.nombre}</td>
                                <td>₡${debe.toFixed(2)}</td>
                                <td>₡${haber.toFixed(2)}</td>
                                <td>${saldo > 0 ? '₡' + saldo.toFixed(2) : '-'}</td>
                                <td>${saldo < 0 ? '₡' + Math.abs(saldo).toFixed(2) : '-'}</td>
                            </tr>
                        `;
                        
                        if (saldo > 0) totalDeudor += saldo;
                        else totalAcreedor += Math.abs(saldo);
                    }
                });
                
                html += `
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: bold; background: rgba(255,215,0,0.1);">
                                <td colspan="2">TOTALES</td>
                                <td>₡${totalDebe.toFixed(2)}</td>
                                <td>₡${totalHaber.toFixed(2)}</td>
                                <td>₡${totalDeudor.toFixed(2)}</td>
                                <td>₡${totalAcreedor.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <p style="margin-top: 1rem; ${Math.abs(totalDebe - totalHaber) < 0.01 ? 'color: var(--color-exito)' : 'color: var(--color-error)'};">
                        ${Math.abs(totalDebe - totalHaber) < 0.01 ? '✓ Balance cuadrado correctamente' : '⚠ Hay diferencias en el balance'}
                    </p>
                `;
                
            contenedor.innerHTML = html;
        };
        
        const abrirDepreciacion = () => {
            const formHTML = `
                <h3><i class="fas fa-calculator"></i> Calculadora de Depreciación</h3>
                <form id="formDepreciacion" onsubmit="calcularDepreciacion(event)">
                    <div class="form-group"><label>Valor del Activo:</label><input type="number" id="valorActivo" step="0.01" required></div>
                    <div class="form-group"><label>Valor Residual:</label><input type="number" id="valorResidual" step="0.01" value="0"></div>
                    <div class="form-group"><label>Vida Útil (años):</label><input type="number" id="vidaUtil" min="1" required></div>
                    <div class="form-group"><label>Método:</label><select id="metodoDepreciacion"><option value="lineal">Línea Recta</option><option value="saldos">Saldos Decrecientes</option></select></div>
                    <button type="submit" class="btn-primary">Calcular Depreciación</button>
                </form>
                <div id="resultadoDepreciacion" style="margin-top: 1rem;"></div>
            `;
            abrirModalConContenido(formHTML);
        };
        
        const calcularDepreciacion = (event) => {
            event.preventDefault();
            const valor = parseFloat(document.getElementById('valorActivo').value);
            const residual = parseFloat(document.getElementById('valorResidual').value);
            const vida = parseInt(document.getElementById('vidaUtil').value);
            const metodo = document.getElementById('metodoDepreciacion').value;
            
            let resultado = '';
            
            if (metodo === 'lineal') {
                const depreciacionAnual = (valor - residual) / vida;
                resultado = `
                    <h4 style="color: var(--color-dorado);">Resultado - Método Línea Recta</h4>
                    <p>Depreciación Anual: ₡${depreciacionAnual.toFixed(2)}</p>
                    <p>Depreciación Mensual: ₡${(depreciacionAnual / 12).toFixed(2)}</p>
                    <p>Valor en Libros al final: ₡${residual.toFixed(2)}</p>
                `;
            } else {
                const tasa = 2 / vida;
                resultado = `
                    <h4 style="color: var(--color-dorado);">Resultado - Saldos Decrecientes</h4>
                    <p>Tasa de Depreciación: ${(tasa * 100).toFixed(2)}%</p>
                    <p>Primer Año: ₡${(valor * tasa).toFixed(2)}</p>
                `;
            }
            
            document.getElementById('resultadoDepreciacion').innerHTML = resultado;
        };
        
        const abrirAnalisisCuentas = async () => {
            try {
                const [cxc, cxp, clientes, proveedores] = await Promise.all([
                    DB.getAll('cuentasPorCobrar'),
                    DB.getAll('cuentasPorPagar'),
                    DB.getAll('clientes'),
                    DB.getAll('proveedores')
                ]);
                
                const hoy = new Date();
                const cxcPendientes = cxc.filter(c => c.estado !== 'pagada');
                const cxcVencidas = cxcPendientes.filter(c => new Date(c.fechaVencimiento) < hoy);
                const cxcAlDia = cxcPendientes.filter(c => new Date(c.fechaVencimiento) >= hoy);
                
                const totalCxcPendiente = cxcPendientes.reduce((s, c) => s + c.saldo, 0);
                const totalCxcVencidas = cxcVencidas.reduce((s, c) => s + c.saldo, 0);
                const totalCxcAlDia = cxcAlDia.reduce((s, c) => s + c.saldo, 0);
                const cxpPendientes = cxp.filter(c => c.estado !== 'pagada');
                const cxpVencidas = cxpPendientes.filter(c => new Date(c.fechaVencimiento) < hoy);
                const cxpAlDia = cxpPendientes.filter(c => new Date(c.fechaVencimiento) >= hoy);
                
                const totalCxpPendiente = cxpPendientes.reduce((s, c) => s + c.saldo, 0);
                const totalCxpVencidas = cxpVencidas.reduce((s, c) => s + c.saldo, 0);
                const totalCxpAlDia = cxpAlDia.reduce((s, c) => s + c.saldo, 0);
                const deudaPorCliente = {};
                cxcPendientes.forEach(c => {
                    if (!deudaPorCliente[c.clienteId]) deudaPorCliente[c.clienteId] = 0;
                    deudaPorCliente[c.clienteId] += c.saldo;
                });
                
                const topClientes = Object.entries(deudaPorCliente)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([id, monto]) => {
                        const cliente = clientes.find(cl => cl.id == id);
                        return { nombre: cliente ? cliente.nombre : 'N/A', monto };
                    });
                const deudaPorProveedor = {};
                cxpPendientes.forEach(c => {
                    if (!deudaPorProveedor[c.proveedorId]) deudaPorProveedor[c.proveedorId] = 0;
                    deudaPorProveedor[c.proveedorId] += c.saldo;
                });
                
                const topProveedores = Object.entries(deudaPorProveedor)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([id, monto]) => {
                        const proveedor = proveedores.find(p => p.id == id);
                        return { nombre: proveedor ? proveedor.nombre : 'N/A', monto };
                    });
                
                const formHTML = `
                    <h3><i class="fas fa-file-invoice-dollar"></i> Análisis de Cuentas</h3>
                    <p style="margin-bottom: 1rem;">Análisis al ${hoy.toLocaleDateString('es-ES')}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">Cuentas por Cobrar</h4>
                            <p><strong>Total Pendiente:</strong> ₡${totalCxcPendiente.toFixed(2)}</p>
                            <p style="color: var(--color-error);"><strong>Vencidas:</strong> ₡${totalCxcVencidas.toFixed(2)} (${cxcVencidas.length} facturas)</p>
                            <p style="color: var(--color-exito);"><strong>Al Día:</strong> ₡${totalCxcAlDia.toFixed(2)} (${cxcAlDia.length} facturas)</p>
                            <p style="margin-top: 0.5rem;"><strong>Promedio por factura:</strong> ₡${cxcPendientes.length > 0 ? (totalCxcPendiente / cxcPendientes.length).toFixed(2) : '0.00'}</p>
                        </div>
                        
                        <div style="padding: 1rem; background: rgba(231, 76, 60, 0.1); border-radius: 8px; border-left: 4px solid #e74c3c;">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">Cuentas por Pagar</h4>
                            <p><strong>Total Pendiente:</strong> ₡${totalCxpPendiente.toFixed(2)}</p>
                            <p style="color: var(--color-error);"><strong>Vencidas:</strong> ₡${totalCxpVencidas.toFixed(2)} (${cxpVencidas.length} facturas)</p>
                            <p style="color: var(--color-exito);"><strong>Al Día:</strong> ₡${totalCxpAlDia.toFixed(2)} (${cxpAlDia.length} facturas)</p>
                            <p style="margin-top: 0.5rem;"><strong>Promedio por factura:</strong> ₡${cxpPendientes.length > 0 ? (totalCxpPendiente / cxpPendientes.length).toFixed(2) : '0.00'}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">Top 5 Clientes con Mayor Deuda</h4>
                            ${topClientes.length > 0 ? topClientes.map((c, i) => `
                                <p style="padding: 0.5rem; background: rgba(255,215,0,0.05); margin-bottom: 0.5rem; border-radius: 4px;">
                                    ${i + 1}. ${c.nombre}: <strong>₡${c.monto.toFixed(2)}</strong>
                                </p>
                            `).join('') : '<p>No hay datos disponibles</p>'}
                        </div>
                        
                        <div>
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">Top 5 Proveedores con Mayor Deuda</h4>
                            ${topProveedores.length > 0 ? topProveedores.map((p, i) => `
                                <p style="padding: 0.5rem; background: rgba(255,215,0,0.05); margin-bottom: 0.5rem; border-radius: 4px;">
                                    ${i + 1}. ${p.nombre}: <strong>₡${p.monto.toFixed(2)}</strong>
                                </p>
                            `).join('') : '<p>No hay datos disponibles</p>'}
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,215,0,0.1); border-radius: 8px;">
                        <h4 style="color: var(--color-dorado);">Indicadores Financieros</h4>
                        <p><strong>Razón de Liquidez (CxC/CxP):</strong> ${totalCxpPendiente > 0 ? (totalCxcPendiente / totalCxpPendiente).toFixed(2) : 'N/A'}</p>
                        <p><strong>Capital de Trabajo Neto:</strong> ₡${(totalCxcPendiente - totalCxpPendiente).toFixed(2)}</p>
                        <p><strong>% de Cuentas Vencidas (CxC):</strong> ${cxcPendientes.length > 0 ? ((cxcVencidas.length / cxcPendientes.length) * 100).toFixed(1) : '0'}%</p>
                        <p><strong>% de Cuentas Vencidas (CxP):</strong> ${cxpPendientes.length > 0 ? ((cxpVencidas.length / cxpPendientes.length) * 100).toFixed(1) : '0'}%</p>
                    </div>
                `;
                abrirModalConContenido(formHTML);
            } catch (error) {
                console.error('Error en análisis de cuentas:', error);
                mostrarToast('Error al cargar análisis', 'error');
            }
        };
        
        const abrirConciliacion = () => {
            const formHTML = `
                <h3><i class="fas fa-balance-scale"></i> Conciliación Bancaria</h3>
                <form id="formConciliacion">
                    <div class="form-group"><label>Saldo según Banco:</label><input type="number" id="saldoBanco" step="0.01"></div>
                    <div class="form-group"><label>Saldo según Libros:</label><input type="number" id="saldoLibros" step="0.01"></div>
                    <div class="form-group"><label>Depósitos en Tránsito:</label><input type="number" id="depositosTransito" step="0.01" value="0"></div>
                    <div class="form-group"><label>Cheques Pendientes:</label><input type="number" id="chequesPendientes" step="0.01" value="0"></div>
                    <button type="button" class="btn-primary" onclick="realizarConciliacion()">Conciliar</button>
                </form>
                <div id="resultadoConciliacion" style="margin-top: 1rem;"></div>
            `;
            abrirModalConContenido(formHTML);
        };
        
        const realizarConciliacion = () => {
            const saldoBanco = parseFloat(document.getElementById('saldoBanco').value) || 0;
            const saldoLibros = parseFloat(document.getElementById('saldoLibros').value) || 0;
            const depositos = parseFloat(document.getElementById('depositosTransito').value) || 0;
            const cheques = parseFloat(document.getElementById('chequesPendientes').value) || 0;
            
            const saldoConciliado = saldoBanco + depositos - cheques;
            const diferencia = saldoConciliado - saldoLibros;
            
            const resultado = `
                <h4 style="color: var(--color-dorado);">Resultado de Conciliación</h4>
                <p>Saldo Banco: ₡${saldoBanco.toFixed(2)}</p>
                <p>+ Depósitos en Tránsito: ₡${depositos.toFixed(2)}</p>
                <p>- Cheques Pendientes: ₡${cheques.toFixed(2)}</p>
                <p style="font-weight: bold; color: var(--color-dorado);">= Saldo Conciliado: ₡${saldoConciliado.toFixed(2)}</p>
                <p>Saldo según Libros: ₡${saldoLibros.toFixed(2)}</p>
                <p style="font-weight: bold; color: ${Math.abs(diferencia) < 0.01 ? 'var(--color-exito)' : 'var(--color-error)'};">Diferencia: ₡${diferencia.toFixed(2)}</p>
                ${Math.abs(diferencia) < 0.01 ? '<p style="color: var(--color-exito);">✓ Cuentas conciliadas correctamente</p>' : '<p style="color: var(--color-error);">⚠ Hay diferencias que requieren ajuste</p>'}
            `;
            
            document.getElementById('resultadoConciliacion').innerHTML = resultado;
        };
        
        const mostrarNotificaciones = async () => {
            try {
                const [cxc, cxp, eventos, activos] = await Promise.all([
                    DB.getAll('cuentasPorCobrar'),
                    DB.getAll('cuentasPorPagar'),
                    DB.getAll('eventos'),
                    DB.getAll('activos')
                ]);
                
                const hoy = new Date();
                const en7dias = new Date();
                en7dias.setDate(hoy.getDate() + 7);
                
                const notificaciones = [];
                cxc.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) < hoy).forEach(c => {
                    const diasVencidos = Math.floor((hoy - new Date(c.fechaVencimiento)) / (1000 * 60 * 60 * 24));
                    notificaciones.push({
                        tipo: 'urgente',
                        icono: 'fa-exclamation-triangle',
                        titulo: 'Cuenta por Cobrar Vencida',
                        mensaje: `Factura #${c.numeroFactura} vencida hace ${diasVencidos} días. Saldo: ₡${c.saldo.toFixed(2)}`,
                        fecha: c.fechaVencimiento
                    });
                });
                cxc.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) >= hoy && new Date(c.fechaVencimiento) <= en7dias).forEach(c => {
                    const diasRestantes = Math.ceil((new Date(c.fechaVencimiento) - hoy) / (1000 * 60 * 60 * 24));
                    notificaciones.push({
                        tipo: 'advertencia',
                        icono: 'fa-clock',
                        titulo: 'Cuenta por Cobrar Próxima a Vencer',
                        mensaje: `Factura #${c.numeroFactura} vence en ${diasRestantes} días. Saldo: ₡${c.saldo.toFixed(2)}`,
                        fecha: c.fechaVencimiento
                    });
                });
                cxp.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) < hoy).forEach(c => {
                    const diasVencidos = Math.floor((hoy - new Date(c.fechaVencimiento)) / (1000 * 60 * 60 * 24));
                    notificaciones.push({
                        tipo: 'urgente',
                        icono: 'fa-exclamation-circle',
                        titulo: 'Cuenta por Pagar Vencida',
                        mensaje: `Factura #${c.numeroFactura} vencida hace ${diasVencidos} días. Saldo: ₡${c.saldo.toFixed(2)}`,
                        fecha: c.fechaVencimiento
                    });
                });
                cxp.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) >= hoy && new Date(c.fechaVencimiento) <= en7dias).forEach(c => {
                    const diasRestantes = Math.ceil((new Date(c.fechaVencimiento) - hoy) / (1000 * 60 * 60 * 24));
                    notificaciones.push({
                        tipo: 'advertencia',
                        icono: 'fa-bell',
                        titulo: 'Cuenta por Pagar Próxima a Vencer',
                        mensaje: `Factura #${c.numeroFactura} vence en ${diasRestantes} días. Saldo: ₡${c.saldo.toFixed(2)}`,
                        fecha: c.fechaVencimiento
                    });
                });
                eventos.filter(e => new Date(e.fecha) >= hoy && new Date(e.fecha) <= en7dias).forEach(e => {
                    const diasRestantes = Math.ceil((new Date(e.fecha) - hoy) / (1000 * 60 * 60 * 24));
                    notificaciones.push({
                        tipo: 'info',
                        icono: 'fa-calendar-alt',
                        titulo: `Evento: ${e.titulo}`,
                        mensaje: `${diasRestantes === 0 ? 'Hoy' : `En ${diasRestantes} días`} - ${e.descripcion || 'Sin descripción'}`,
                        fecha: e.fecha
                    });
                });
                activos.filter(a => {
                    const mesesDesdeCompra = (hoy - new Date(a.fechaCompra)) / (1000 * 60 * 60 * 24 * 30);
                    return mesesDesdeCompra >= 12 && a.valorEnLibros > a.valorResidual;
                }).forEach(a => {
                    notificaciones.push({
                        tipo: 'info',
                        icono: 'fa-calculator',
                        titulo: 'Depreciación Pendiente',
                        mensaje: `Activo "${a.descripcion}" requiere cálculo de depreciación anual`,
                        fecha: a.fechaCompra
                    });
                });
                document.getElementById('notificationCount').textContent = notificaciones.length;
                const colores = {
                    urgente: '#e74c3c',
                    advertencia: '#f39c12',
                    info: '#3498db'
                };
                
                let html = `
                    <h3><i class="fas fa-bell"></i> Centro de Notificaciones</h3>
                    <p style="margin-bottom: 1rem;">Tienes ${notificaciones.length} notificación(es)</p>
                `;
                
                if (notificaciones.length === 0) {
                    html += '<p style="text-align: center; padding: 2rem; opacity: 0.7;">No hay notificaciones pendientes</p>';
                } else {
                    notificaciones.forEach(n => {
                        html += `
                            <div style="padding: 1rem; margin-bottom: 1rem; background: rgba(255,215,0,0.05); border-left: 4px solid ${colores[n.tipo]}; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <i class="fas ${n.icono}" style="color: ${colores[n.tipo]}; font-size: 1.5rem;"></i>
                                    <div style="flex: 1;">
                                        <h4 style="color: var(--color-dorado); margin-bottom: 0.5rem;">${n.titulo}</h4>
                                        <p style="margin: 0;">${n.mensaje}</p>
                                        <small style="opacity: 0.7;">Fecha: ${new Date(n.fecha).toLocaleDateString('es-ES')}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                abrirModalConContenido(html);
            } catch (error) {
                console.error('Error mostrando notificaciones:', error);
                mostrarToast('Error al cargar notificaciones', 'error');
            }
        };
        const actualizarContadorNotificaciones = async () => {
            try {
                const [cxc, cxp, eventos] = await Promise.all([
                    DB.getAll('cuentasPorCobrar'),
                    DB.getAll('cuentasPorPagar'),
                    DB.getAll('eventos')
                ]);
                
                const hoy = new Date();
                const en7dias = new Date();
                en7dias.setDate(hoy.getDate() + 7);
                
                let count = 0;
                count += cxc.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) < hoy).length;
                count += cxc.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) >= hoy && new Date(c.fechaVencimiento) <= en7dias).length;
                count += cxp.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) < hoy).length;
                count += cxp.filter(c => c.estado !== 'pagada' && new Date(c.fechaVencimiento) >= hoy && new Date(c.fechaVencimiento) <= en7dias).length;
                count += eventos.filter(e => new Date(e.fecha) >= hoy && new Date(e.fecha) <= en7dias).length;
                
                const notifElement = document.getElementById('notificationCount');
                if (notifElement) {
                    notifElement.textContent = count;
                    notifElement.style.display = count > 0 ? 'block' : 'none';
                }
            } catch (error) {
                console.warn('Error actualizando notificaciones:', error);
                // No mostrar error al usuario, solo en consola
            }
        };

        const abrirModalConContenido = (content) => {
            document.getElementById('modal-contenido').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
        };
        const exportarClientesExcel = async () => {
            try {
                const clientes = await DB.getAll('clientes');
                if (clientes.length === 0) {
                    mostrarToast('No hay clientes para exportar', 'warning');
                    return;
                }
                
                let csv = 'ID,Nombre,Cédula,Email,Teléfono,Dirección,Empresa,Tipo,Descuento,Fecha Registro\n';
                clientes.forEach(c => {
                    csv += `${c.id},"${c.nombre}","${c.cedula}","${c.email}","${c.telefono}","${c.direccion || ''}","${c.empresa || ''}","${c.tipoCliente || 'regular'}",${c.descuento || 0},"${new Date(c.fechaRegistro).toLocaleDateString('es-ES')}"\n`;
                });
                
                descargarCSV(csv, 'clientes-ajhb.csv');
            } catch (error) {
                console.error('Error exportando clientes:', error);
                mostrarToast('Error al exportar clientes', 'error');
            }
        };
        
        const exportarAsientosExcel = async () => {
            try {
                const [asientos, detalles, cuentas] = await Promise.all([
                    DB.getAll('asientos'),
                    DB.getAll('detallesAsiento'),
                    DB.getAll('cuentas')
                ]);
                
                if (asientos.length === 0) {
                    mostrarToast('No hay asientos contables para exportar', 'warning');
                    return;
                }
                
                let csv = 'Número Asiento,Fecha,Tipo,Descripción,Código Cuenta,Nombre Cuenta,Debe,Haber\n';
                asientos.forEach(a => {
                    const movimientos = detalles.filter(d => d.asientoId === a.id);
                    movimientos.forEach(m => {
                        const cuenta = cuentas.find(c => c.id === m.cuentaId);
                        csv += `"${a.numero}","${a.fecha}","${a.tipo}","${a.descripcion}","${cuenta?.codigo || ''}","${cuenta?.nombre || ''}",${m.debe},${m.haber}\n`;
                    });
                });
                
                descargarCSV(csv, 'asientos-contables-ajhb.csv');
            } catch (error) {
                console.error('Error exportando asientos:', error);
                mostrarToast('Error al exportar asientos', 'error');
            }
        };
        
        const exportarCuentasCobrarExcel = async () => {
            try {
                const [cxc, clientes] = await Promise.all([
                    DB.getAll('cuentasPorCobrar'),
                    DB.getAll('clientes')
                ]);
                
                if (cxc.length === 0) {
                    mostrarToast('No hay cuentas por cobrar para exportar', 'warning');
                    return;
                }
                
                let csv = 'ID,Cliente,Número Factura,Monto,Saldo,Fecha Emisión,Fecha Vencimiento,Estado\n';
                cxc.forEach(c => {
                    const cliente = clientes.find(cl => cl.id === c.clienteId);
                    csv += `${c.id},"${cliente?.nombre || 'N/A'}","${c.numeroFactura}",${c.monto},${c.saldo},"${c.fechaEmision}","${c.fechaVencimiento}","${c.estado}"\n`;
                });
                
                descargarCSV(csv, 'cuentas-por-cobrar-ajhb.csv');
            } catch (error) {
                console.error('Error exportando cuentas por cobrar:', error);
                mostrarToast('Error al exportar cuentas', 'error');
            }
        };
        
        const exportarReportePDF = (tipo) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('AJHB Bienes Raíces', 20, 20);
            doc.setFontSize(12);
            doc.text(`Reporte: ${tipo}`, 20, 30);
            doc.setFontSize(10);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, 38);
            const contenedor = document.getElementById('contenedorReporte');
            if (!contenedor || contenedor.classList.contains('hidden')) {
                mostrarToast('Primero genera el reporte para poder exportarlo', 'warning');
                return;
            }
            
            const texto = contenedor.innerText;
            const lineas = doc.splitTextToSize(texto, 170);
            
            let y = 50;
            lineas.forEach(linea => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(linea, 20, y);
                y += 5;
            });
            
            doc.save(`reporte-${tipo}-ajhb.pdf`);
        };
        
        const descargarCSV = (contenido, nombreArchivo) => {
            const blob = new Blob(['\ufeff' + contenido], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', nombreArchivo);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const generarResumenFinanciero = async () => {
            try {
                const [clientes, proveedores, cxc, cxp, bancos, activos, asientos, detalles, cuentas] = await Promise.all([
                    DB.getAll('clientes'),
                    DB.getAll('proveedores'),
                    DB.getAll('cuentasPorCobrar'),
                    DB.getAll('cuentasPorPagar'),
                    DB.getAll('bancos'),
                    DB.getAll('activos'),
                    DB.getAll('asientos'),
                    DB.getAll('detallesAsiento'),
                    DB.getAll('cuentas')
                ]);
                const totalClientes = clientes.length;
                const totalProveedores = proveedores.length;
                const totalAsientos = asientos.length;
                
                const hoy = new Date();
                const saldoBancos = bancos.reduce((s, b) => s + b.saldo, 0);
                const cxcPendientes = cxc.filter(c => c.estado !== 'pagada');
                const totalCxC = cxcPendientes.reduce((s, c) => s + c.saldo, 0);
                const cxcVencidas = cxcPendientes.filter(c => new Date(c.fechaVencimiento) < hoy);
                const totalCxCVencidas = cxcVencidas.reduce((s, c) => s + c.saldo, 0);
                
                const cxpPendientes = cxp.filter(c => c.estado !== 'pagada');
                const totalCxP = cxpPendientes.reduce((s, c) => s + c.saldo, 0);
                const cxpVencidas = cxpPendientes.filter(c => new Date(c.fechaVencimiento) < hoy);
                const totalCxPVencidas = cxpVencidas.reduce((s, c) => s + c.saldo, 0);
                
                const valorActivos = activos.reduce((s, a) => s + a.valorEnLibros, 0);
                const depreciacionAcum = activos.reduce((s, a) => s + a.depreciacionAcumulada, 0);
                let totalIngresos = 0;
                let totalGastos = 0;
                detalles.forEach(d => {
                    const cuenta = cuentas.find(c => c.id === d.cuentaId);
                    if (cuenta) {
                        if (cuenta.tipo === 'ingreso') totalIngresos += d.haber - d.debe;
                        if (cuenta.tipo === 'gasto') totalGastos += d.debe - d.haber;
                    }
                });
                
                const utilidadNeta = totalIngresos - totalGastos;
                const activoCorriente = saldoBancos + totalCxC;
                const totalActivos = activoCorriente + valorActivos;
                const totalPasivos = totalCxP;
                const patrimonio = totalActivos - totalPasivos;
                const razonLiquidez = totalPasivos > 0 ? (activoCorriente / totalPasivos).toFixed(2) : 'N/A';
                const margenUtilidad = totalIngresos > 0 ? ((utilidadNeta / totalIngresos) * 100).toFixed(1) : '0';
                
                const html = `
                    <h3><i class="fas fa-chart-pie"></i> Resumen Financiero Consolidado</h3>
                    <p style="margin-bottom: 1.5rem;">Análisis al ${hoy.toLocaleDateString('es-ES', { dateStyle: 'long' })}</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div style="padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">₡${saldoBancos.toFixed(0)}</div>
                            <div style="opacity: 0.9;">Efectivo en Bancos</div>
                        </div>
                        <div style="padding: 1rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">₡${totalCxC.toFixed(0)}</div>
                            <div style="opacity: 0.9;">Por Cobrar</div>
                        </div>
                        <div style="padding: 1rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">₡${totalCxP.toFixed(0)}</div>
                            <div style="opacity: 0.9;">Por Pagar</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="padding: 1.5rem; background: rgba(255,215,0,0.1); border-radius: 8px; border-left: 4px solid var(--color-dorado);">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">📊 Indicadores Clave</h4>
                            <p><strong>Razón de Liquidez:</strong> ${razonLiquidez}</p>
                            <p><strong>Capital de Trabajo:</strong> ₡${(activoCorriente - totalPasivos).toFixed(2)}</p>
                            <p><strong>Margen de Utilidad:</strong> ${margenUtilidad}%</p>
                            <p><strong>ROA (Retorno sobre Activos):</strong> ${totalActivos > 0 ? ((utilidadNeta / totalActivos) * 100).toFixed(1) : '0'}%</p>
                        </div>
                        
                        <div style="padding: 1.5rem; background: rgba(255,215,0,0.1); border-radius: 8px; border-left: 4px solid var(--color-dorado);">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;">💼 Operaciones</h4>
                            <p><strong>Total Clientes:</strong> ${totalClientes}</p>
                            <p><strong>Total Proveedores:</strong> ${totalProveedores}</p>
                            <p><strong>Asientos Contables:</strong> ${totalAsientos}</p>
                            <p><strong>Activos Registrados:</strong> ${activos.length}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="padding: 1.5rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <h4 style="color: #4CAF50; margin-bottom: 1rem;">💰 Balance General Resumido</h4>
                            <p><strong>Activo Corriente:</strong> ₡${activoCorriente.toFixed(2)}</p>
                            <p><strong>Activo No Corriente:</strong> ₡${valorActivos.toFixed(2)}</p>
                            <p style="font-weight: bold; color: var(--color-dorado);">Total Activos: ₡${totalActivos.toFixed(2)}</p>
                            <hr style="margin: 1rem 0; border-color: rgba(255,215,0,0.3);">
                            <p><strong>Pasivos:</strong> ₡${totalPasivos.toFixed(2)}</p>
                            <p><strong>Patrimonio:</strong> ₡${patrimonio.toFixed(2)}</p>
                        </div>
                        
                        <div style="padding: 1.5rem; background: rgba(33, 150, 243, 0.1); border-radius: 8px;">
                            <h4 style="color: #2196F3; margin-bottom: 1rem;">📈 Estado de Resultados</h4>
                            <p><strong>Ingresos Totales:</strong> <span style="color: var(--color-exito);">₡${totalIngresos.toFixed(2)}</span></p>
                            <p><strong>Gastos Totales:</strong> <span style="color: var(--color-error);">₡${totalGastos.toFixed(2)}</span></p>
                            <hr style="margin: 1rem 0; border-color: rgba(255,215,0,0.3);">
                            <p style="font-weight: bold; font-size: 1.2rem; color: ${utilidadNeta >= 0 ? 'var(--color-exito)' : 'var(--color-error)'};">
                                Utilidad Neta: ₡${utilidadNeta.toFixed(2)}
                            </p>
                        </div>
                    </div>
                    
                    ${cxcVencidas.length > 0 || cxpVencidas.length > 0 ? `
                        <div style="padding: 1.5rem; background: rgba(231, 76, 60, 0.1); border-radius: 8px; border-left: 4px solid #e74c3c;">
                            <h4 style="color: #e74c3c; margin-bottom: 1rem;">⚠️ Alertas Importantes</h4>
                            ${cxcVencidas.length > 0 ? `<p><strong>${cxcVencidas.length}</strong> cuentas por cobrar vencidas por ₡${totalCxCVencidas.toFixed(2)}</p>` : ''}
                            ${cxpVencidas.length > 0 ? `<p><strong>${cxpVencidas.length}</strong> cuentas por pagar vencidas por ₡${totalCxPVencidas.toFixed(2)}</p>` : ''}
                        </div>
                    ` : `
                        <div style="padding: 1.5rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50; text-align: center;">
                            <h4 style="color: #4CAF50;">✓ No hay cuentas vencidas</h4>
                            <p>Todas las cuentas están al día</p>
                        </div>
                    `}
                `;
                
                abrirModalConContenido(html);
            } catch (error) {
                console.error('Error generando resumen:', error);
                mostrarToast('Error al generar resumen financiero', 'error');
            }
        };
        const inicializarCatalogoCuentas = async () => {
            const cuentasBase = [
                { codigo: '1', nombre: 'ACTIVO', tipo: 'activo', categoria: 'grupo', nivel: 1, padre: null },
                { codigo: '1.1', nombre: 'ACTIVO CORRIENTE', tipo: 'activo', categoria: 'subgrupo', nivel: 2, padre: '1' },
                { codigo: '1.1.01', nombre: 'Caja', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.1' },
                { codigo: '1.1.02', nombre: 'Bancos', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.1' },
                { codigo: '1.1.03', nombre: 'Cuentas por Cobrar', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.1' },
                { codigo: '1.1.04', nombre: 'Inventarios', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.1' },
                { codigo: '1.2', nombre: 'ACTIVO NO CORRIENTE', tipo: 'activo', categoria: 'subgrupo', nivel: 2, padre: '1' },
                { codigo: '1.2.01', nombre: 'Terrenos', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.2' },
                { codigo: '1.2.02', nombre: 'Edificios', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.2' },
                { codigo: '1.2.03', nombre: 'Mobiliario y Equipo', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.2' },
                { codigo: '1.2.04', nombre: 'Vehículos', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.2' },
                { codigo: '1.2.05', nombre: 'Depreciación Acumulada', tipo: 'activo', categoria: 'detalle', nivel: 3, padre: '1.2' },
                { codigo: '2', nombre: 'PASIVO', tipo: 'pasivo', categoria: 'grupo', nivel: 1, padre: null },
                { codigo: '2.1', nombre: 'PASIVO CORRIENTE', tipo: 'pasivo', categoria: 'subgrupo', nivel: 2, padre: '2' },
                { codigo: '2.1.01', nombre: 'Cuentas por Pagar', tipo: 'pasivo', categoria: 'detalle', nivel: 3, padre: '2.1' },
                { codigo: '2.1.02', nombre: 'IVA por Pagar', tipo: 'pasivo', categoria: 'detalle', nivel: 3, padre: '2.1' },
                { codigo: '2.1.03', nombre: 'Préstamos Bancarios CP', tipo: 'pasivo', categoria: 'detalle', nivel: 3, padre: '2.1' },
                { codigo: '2.2', nombre: 'PASIVO NO CORRIENTE', tipo: 'pasivo', categoria: 'subgrupo', nivel: 2, padre: '2' },
                { codigo: '2.2.01', nombre: 'Préstamos Bancarios LP', tipo: 'pasivo', categoria: 'detalle', nivel: 3, padre: '2.2' },
                { codigo: '2.2.02', nombre: 'Hipotecas por Pagar', tipo: 'pasivo', categoria: 'detalle', nivel: 3, padre: '2.2' },
                { codigo: '3', nombre: 'PATRIMONIO', tipo: 'patrimonio', categoria: 'grupo', nivel: 1, padre: null },
                { codigo: '3.1', nombre: 'Capital Social', tipo: 'patrimonio', categoria: 'detalle', nivel: 2, padre: '3' },
                { codigo: '3.2', nombre: 'Utilidades Retenidas', tipo: 'patrimonio', categoria: 'detalle', nivel: 2, padre: '3' },
                { codigo: '3.3', nombre: 'Utilidad del Ejercicio', tipo: 'patrimonio', categoria: 'detalle', nivel: 2, padre: '3' },
                { codigo: '4', nombre: 'INGRESOS', tipo: 'ingreso', categoria: 'grupo', nivel: 1, padre: null },
                { codigo: '4.1', nombre: 'Ingresos Operacionales', tipo: 'ingreso', categoria: 'subgrupo', nivel: 2, padre: '4' },
                { codigo: '4.1.01', nombre: 'Ventas', tipo: 'ingreso', categoria: 'detalle', nivel: 3, padre: '4.1' },
                { codigo: '4.1.02', nombre: 'Servicios Prestados', tipo: 'ingreso', categoria: 'detalle', nivel: 3, padre: '4.1' },
                { codigo: '4.2', nombre: 'Otros Ingresos', tipo: 'ingreso', categoria: 'detalle', nivel: 2, padre: '4' },
                { codigo: '5', nombre: 'GASTOS', tipo: 'gasto', categoria: 'grupo', nivel: 1, padre: null },
                { codigo: '5.1', nombre: 'Costo de Ventas', tipo: 'gasto', categoria: 'detalle', nivel: 2, padre: '5' },
                { codigo: '5.2', nombre: 'GASTOS OPERATIVOS', tipo: 'gasto', categoria: 'subgrupo', nivel: 2, padre: '5' },
                { codigo: '5.2.01', nombre: 'Salarios', tipo: 'gasto', categoria: 'detalle', nivel: 3, padre: '5.2' },
                { codigo: '5.2.02', nombre: 'Alquileres', tipo: 'gasto', categoria: 'detalle', nivel: 3, padre: '5.2' },
                { codigo: '5.2.03', nombre: 'Servicios Públicos', tipo: 'gasto', categoria: 'detalle', nivel: 3, padre: '5.2' },
                { codigo: '5.2.04', nombre: 'Depreciación', tipo: 'gasto', categoria: 'detalle', nivel: 3, padre: '5.2' },
                { codigo: '5.2.05', nombre: 'Mantenimiento', tipo: 'gasto', categoria: 'detalle', nivel: 3, padre: '5.2' },
                { codigo: '5.3', nombre: 'Gastos Financieros', tipo: 'gasto', categoria: 'detalle', nivel: 2, padre: '5' }
            ];

            try {
                for (const cuenta of cuentasBase) {
                    await DB.add('cuentas', cuenta);
                }
                mostrarToast('Catálogo de cuentas inicializado', 'success');
            } catch (error) {
                console.error('Error inicializando catálogo:', error);
            }
        };

        const verificarCatalogoCuentas = async () => {
            try {
                const cuentas = await DB.getAll('cuentas');
                if (cuentas.length === 0) {
                    await inicializarCatalogoCuentas();
                }
            } catch (error) {
                console.error('Error verificando catálogo:', error);
            }
        };

        const mostrarCatalogoCuentas = async () => {
            try {
                const cuentasData = await DB.getAll('cuentas');
                const cuentas = cuentasData.sort((a, b) => a.codigo.localeCompare(b.codigo));
                let html = `
                    <h3>Catálogo de Cuentas</h3>
                    <div class="tabla-container">
                        <table>
                            <thead><tr><th>Código</th><th>Nombre</th><th>Tipo</th><th>Categoría</th></tr></thead>
                            <tbody>
                `;
                cuentas.forEach(c => {
                    const indent = '&nbsp;'.repeat((c.nivel - 1) * 4);
                    html += `<tr><td>${c.codigo}</td><td>${indent}${c.nombre}</td><td>${c.tipo}</td><td>${c.categoria}</td></tr>`;
                });
                html += '</tbody></table></div>';
                abrirModalConContenido(html);
            } catch (error) {
                console.error('Error mostrando catálogo:', error);
                mostrarToast('Error al cargar catálogo de cuentas', 'error');
            }
        };
        const abrirFormularioAsiento = async () => {
            try {
                asientoActual = { debe: [], haber: [] };
                const cuentas = await DB.getAll('cuentas');
                const cuentasDetalle = cuentas.filter(c => c.categoria === 'detalle');
                const options = cuentasDetalle.map(c => `<option value="${c.id}">${c.codigo} - ${c.nombre}</option>`).join('');
                
                const formHTML = `
                    <h3>Nuevo Asiento Contable</h3>
                    <form id="formAsiento">
                        <div class="form-group"><label>Número:</label><input type="text" id="numeroAsiento" required></div>
                        <div class="form-group"><label>Fecha:</label><input type="date" id="fechaAsiento" value="${new Date().toISOString().split('T')[0]}" required></div>
                        <div class="form-group"><label>Tipo:</label><select id="tipoAsiento"><option value="diario">Diario</option><option value="ajuste">Ajuste</option><option value="cierre">Cierre</option></select></div>
                        <div class="form-group"><label>Descripción:</label><textarea id="descripcionAsiento" rows="2" required></textarea></div>
                        
                        <h4 style="color: var(--color-dorado); margin-top: 1rem;">Debe</h4>
                        <div id="debeContainer"></div>
                        <button type="button" class="btn-secondary" onclick="agregarLineaDebe()">+ Agregar Debe</button>
                        
                        <h4 style="color: var(--color-dorado); margin-top: 1rem;">Haber</h4>
                        <div id="haberContainer"></div>
                        <button type="button" class="btn-secondary" onclick="agregarLineaHaber()">+ Agregar Haber</button>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,215,0,0.1); border-radius: 4px;">
                            <p><strong>Total Debe:</strong> <span id="totalDebe">₡0.00</span></p>
                            <p><strong>Total Haber:</strong> <span id="totalHaber">₡0.00</span></p>
                            <p><strong>Diferencia:</strong> <span id="diferencia">₡0.00</span></p>
                        </div>
                        
                        <button type="button" class="btn-primary" onclick="guardarAsiento()" style="margin-top: 1rem;">Guardar Asiento</button>
                    </form>
                `;
                abrirModalConContenido(formHTML);
                window.cuentasOptions = options;
                agregarLineaDebe();
                agregarLineaHaber();
            } catch (error) {
                console.error('Error cargando cuentas:', error);
                mostrarToast('Error al cargar el catálogo de cuentas', 'error');
            }
        };

        const agregarLineaDebe = () => {
            const container = document.getElementById('debeContainer');
            const index = asientoActual.debe.length;
            const div = document.createElement('div');
            div.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;';
            div.innerHTML = `
                <select class="cuenta-debe" data-index="${index}">${window.cuentasOptions}</select>
                <input type="number" class="monto-debe" data-index="${index}" step="0.01" placeholder="Monto" onchange="calcularTotalesAsiento()">
                <button type="button" class="btn-error" onclick="eliminarLineaDebe(${index})">X</button>
            `;
            container.appendChild(div);
            asientoActual.debe.push({ cuentaId: null, monto: 0 });
        };

        const agregarLineaHaber = () => {
            const container = document.getElementById('haberContainer');
            const index = asientoActual.haber.length;
            const div = document.createElement('div');
            div.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;';
            div.innerHTML = `
                <select class="cuenta-haber" data-index="${index}">${window.cuentasOptions}</select>
                <input type="number" class="monto-haber" data-index="${index}" step="0.01" placeholder="Monto" onchange="calcularTotalesAsiento()">
                <button type="button" class="btn-error" onclick="eliminarLineaHaber(${index})">X</button>
            `;
            container.appendChild(div);
            asientoActual.haber.push({ cuentaId: null, monto: 0 });
        };

        const eliminarLineaDebe = (index) => {
            asientoActual.debe.splice(index, 1);
            document.getElementById('debeContainer').children[index].remove();
            calcularTotalesAsiento();
        };

        const eliminarLineaHaber = (index) => {
            asientoActual.haber.splice(index, 1);
            document.getElementById('haberContainer').children[index].remove();
            calcularTotalesAsiento();
        };

        const calcularTotalesAsiento = () => {
            const totalDebe = Array.from(document.querySelectorAll('.monto-debe'))
                .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            const totalHaber = Array.from(document.querySelectorAll('.monto-haber'))
                .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            
            document.getElementById('totalDebe').textContent = `₡${totalDebe.toFixed(2)}`;
            document.getElementById('totalHaber').textContent = `₡${totalHaber.toFixed(2)}`;
            document.getElementById('diferencia').textContent = `₡${Math.abs(totalDebe - totalHaber).toFixed(2)}`;
        };

        const guardarAsiento = async () => {
            const numero = document.getElementById('numeroAsiento').value;
            const fecha = document.getElementById('fechaAsiento').value;
            const tipo = document.getElementById('tipoAsiento').value;
            const descripcion = document.getElementById('descripcionAsiento').value;
            
            const debe = Array.from(document.querySelectorAll('.cuenta-debe')).map((select, i) => ({
                cuentaId: parseInt(select.value),
                monto: parseFloat(document.querySelectorAll('.monto-debe')[i].value) || 0
            }));
            
            const haber = Array.from(document.querySelectorAll('.cuenta-haber')).map((select, i) => ({
                cuentaId: parseInt(select.value),
                monto: parseFloat(document.querySelectorAll('.monto-haber')[i].value) || 0
            }));
            
            const totalDebe = debe.reduce((sum, d) => sum + d.monto, 0);
            const totalHaber = haber.reduce((sum, h) => sum + h.monto, 0);
            
            if (Math.abs(totalDebe - totalHaber) > 0.01) {
                mostrarToast('El asiento no está cuadrado. Debe y Haber deben ser iguales.', 'error', 'Asiento Descuadrado');
                return;
            }
            
            const asiento = {
                numero, fecha, tipo, descripcion,
                totalDebe, totalHaber,
                estado: 'activo',
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                const asientoId = await DB.add('asientos', asiento);
                
                for (const d of debe) {
                    await DB.add('detallesAsiento', { asientoId, cuentaId: d.cuentaId, debe: d.monto, haber: 0 });
                }
                
                for (const h of haber) {
                    await DB.add('detallesAsiento', { asientoId, cuentaId: h.cuentaId, debe: 0, haber: h.monto });
                }
                
                cerrarModal();
                cargarAsientos();
                actualizarWidgets();
                mostrarToast('Asiento contable guardado exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando asiento:', error);
                mostrarToast('Error al guardar el asiento', 'error');
            }
        };

        const cargarAsientos = async () => {
            try {
                const asientos = await DB.getAll('asientos');
                const tbody = document.getElementById('cuerpoTablaAsientos');
                tbody.innerHTML = '';
                asientos.forEach(asiento => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${asiento.numero}</td>
                            <td>${asiento.fecha}</td>
                            <td>${asiento.tipo}</td>
                            <td>${asiento.descripcion}</td>
                            <td>₡${asiento.totalDebe.toFixed(2)}</td>
                            <td>₡${asiento.totalHaber.toFixed(2)}</td>
                            <td><span style="color: ${asiento.estado === 'activo' ? 'var(--color-exito)' : 'var(--color-error)'};">${asiento.estado}</span></td>
                            <td>
                                <button class="btn-info" onclick="verDetalleAsiento(${asiento.id})">Ver</button>
                                <button class="btn-error" onclick="eliminarAsiento(${asiento.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando asientos:', error);
            }
        };

        const verDetalleAsiento = async (id) => {
            try {
                const [asiento, detalles, cuentas] = await Promise.all([
                    DB.get('asientos', id),
                    DB.getAll('detallesAsiento'),
                    DB.getAll('cuentas')
                ]);
                
                const asientoDetalles = detalles.filter(d => d.asientoId === id);
                let html = `
                    <h3>Asiento #${asiento.numero}</h3>
                    <p><strong>Fecha:</strong> ${asiento.fecha}</p>
                    <p><strong>Descripción:</strong> ${asiento.descripcion}</p>
                    <div class="tabla-container">
                        <table>
                            <thead><tr><th>Cuenta</th><th>Debe</th><th>Haber</th></tr></thead>
                            <tbody>
                `;
                
                asientoDetalles.forEach(detalle => {
                    const cuenta = cuentas.find(c => c.id === detalle.cuentaId);
                    if (cuenta) {
                        html += `<tr><td>${cuenta.codigo} - ${cuenta.nombre}</td><td>₡${detalle.debe.toFixed(2)}</td><td>₡${detalle.haber.toFixed(2)}</td></tr>`;
                    }
                });
                
                html += `
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background: rgba(255,215,0,0.1);">
                                    <td>TOTALES</td>
                                    <td>₡${asiento.totalDebe.toFixed(2)}</td>
                                    <td>₡${asiento.totalHaber.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                abrirModalConContenido(html);
            } catch (error) {
                console.error('Error mostrando detalle:', error);
                mostrarToast('Error al cargar detalle del asiento', 'error');
            }
        };

        const eliminarAsiento = (id) => {
            confirmarAccion(
                'Se eliminará el asiento contable y todos sus movimientos.',
                async () => {
                    try {
                        await DB.delete('asientos', id);
                        cargarAsientos(); 
                        actualizarWidgets();
                        mostrarToast('Asiento eliminado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando asiento:', error);
                        mostrarToast('Error al eliminar el asiento', 'error');
                    }
                },
                '¿Eliminar Asiento?'
            );
        };

        const buscarAsientos = async () => {
            try {
                const termino = document.getElementById('buscarAsiento').value.toLowerCase();
                const asientos = await DB.getAll('asientos');
                const filtrados = asientos.filter(a => 
                    a.numero.toLowerCase().includes(termino) || 
                    a.descripcion.toLowerCase().includes(termino)
                );
                const tbody = document.getElementById('cuerpoTablaAsientos');
                tbody.innerHTML = '';
                filtrados.forEach(asiento => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${asiento.numero}</td>
                            <td>${asiento.fecha}</td>
                            <td>${asiento.tipo}</td>
                            <td>${asiento.descripcion}</td>
                            <td>₡${asiento.totalDebe.toFixed(2)}</td>
                            <td>₡${asiento.totalHaber.toFixed(2)}</td>
                            <td><span style="color: ${asiento.estado === 'activo' ? 'var(--color-exito)' : 'var(--color-error)'};">${asiento.estado}</span></td>
                            <td>
                                <button class="btn-info" onclick="verDetalleAsiento(${asiento.id})">Ver</button>
                                <button class="btn-error" onclick="eliminarAsiento(${asiento.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error buscando asientos:', error);
            }
        };
        const abrirFormularioProveedor = (id = null) => {
            const onsuccess = (proveedor = {}) => {
                const formHTML = `
                    <h3>${proveedor.id ? 'Editar' : 'Nuevo'} Proveedor</h3>
                    <form id="formProveedor" onsubmit="guardarProveedor(event, ${proveedor.id || 'null'})">
                        <div class="form-group"><label>Nombre:</label><input type="text" id="nombreProv" value="${proveedor.nombre || ''}" required></div>
                        <div class="form-group"><label>Cédula Jurídica:</label><input type="text" id="cedulaProv" value="${proveedor.cedula || ''}" required></div>
                        <div class="form-group"><label>Email:</label><input type="email" id="emailProv" value="${proveedor.email || ''}"></div>
                        <div class="form-group"><label>Teléfono:</label><input type="tel" id="telefonoProv" value="${proveedor.telefono || ''}"></div>
                        <div class="form-group"><label>Dirección:</label><textarea id="direccionProv" rows="2">${proveedor.direccion || ''}</textarea></div>
                        <button type="submit" class="btn-primary">Guardar</button>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            };
            
            if (id) {
                DB.get('proveedores', id).then(proveedor => onsuccess(proveedor)).catch(e => console.error("Error fetching proveedor", e));
            } else {
                onsuccess();
            }
        };

        const guardarProveedor = async (event, id) => {
            event.preventDefault();
            const data = {
                nombre: document.getElementById('nombreProv').value,
                cedula: document.getElementById('cedulaProv').value,
                email: document.getElementById('emailProv').value,
                telefono: document.getElementById('telefonoProv').value,
                direccion: document.getElementById('direccionProv').value,
                saldo: 0
            };
            
            try {
                if (id) {
                    await DB.put('proveedores', id, data);
                } else {
                    data.fechaRegistro = new Date().toISOString();
                    await DB.add('proveedores', data);
                }
                cerrarModal(); cargarProveedores();
                mostrarToast(`Proveedor ${id ? 'actualizado' : 'guardado'} exitosamente`, 'success');
            } catch (error) {
                console.error('Error guardando proveedor:', error);
                mostrarToast('Error al guardar el proveedor', 'error');
            }
        };

        const cargarProveedores = async () => {
            try {
                const [proveedores, cuentasPagar] = await Promise.all([
                    DB.getAll('proveedores'),
                    DB.getAll('cuentasPorPagar')
                ]);
                const tbody = document.getElementById('cuerpoTablaProveedores');
                tbody.innerHTML = '';
                proveedores.forEach(prov => {
                    const saldo = cuentasPagar
                        .filter(c => c.proveedorId === prov.id && c.estado !== 'pagada')
                        .reduce((sum, c) => sum + (c.saldo || c.monto), 0);
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${prov.id}</td>
                            <td>${prov.nombre}</td>
                            <td>${prov.cedula}</td>
                            <td>${prov.email || 'N/A'}</td>
                            <td>${prov.telefono || 'N/A'}</td>
                            <td>₡${saldo.toFixed(2)}</td>
                            <td>
                                <button class="btn-secondary" onclick="abrirFormularioProveedor(${prov.id})">Editar</button>
                                <button class="btn-error" onclick="eliminarProveedor(${prov.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando proveedores:', error);
            }
        };

        const eliminarProveedor = (id) => {
            confirmarAccion(
                'Se eliminará el proveedor y toda su información.',
                async () => {
                    try {
                        await DB.delete('proveedores', id);
                        cargarProveedores();
                        mostrarToast('Proveedor eliminado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando proveedor:', error);
                        mostrarToast('Error al eliminar el proveedor', 'error');
                    }
                },
                '¿Eliminar Proveedor?'
            );
        };

        const buscarProveedores = async () => {
            try {
                const termino = document.getElementById('buscarProveedor').value.toLowerCase();
                const proveedores = await DB.getAll('proveedores');
                const filtrados = proveedores.filter(p => 
                    p.nombre.toLowerCase().includes(termino) || 
                    p.cedula.includes(termino)
                );
                const tbody = document.getElementById('cuerpoTablaProveedores');
                tbody.innerHTML = '';
                filtrados.forEach(prov => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${prov.id}</td>
                            <td>${prov.nombre}</td>
                            <td>${prov.cedula}</td>
                            <td>${prov.email || 'N/A'}</td>
                            <td>${prov.telefono || 'N/A'}</td>
                            <td>₡${prov.saldo ? prov.saldo.toFixed(2) : '0.00'}</td>
                            <td>
                                <button class="btn-secondary" onclick="abrirFormularioProveedor(${prov.id})">Editar</button>
                                <button class="btn-error" onclick="eliminarProveedor(${prov.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error buscando proveedores:', error);
            }
        };
        const abrirFormularioCuentaCobrar = async () => {
            try {
                const clientes = await DB.getAll('clientes');
                const options = clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
                const formHTML = `
                    <h3>Nueva Cuenta por Cobrar</h3>
                    <form id="formCuentaCobrar" onsubmit="guardarCuentaCobrar(event)">
                        <div class="form-group"><label>Cliente:</label><select id="clienteCobrar" required>${options}</select></div>
                        <div class="form-group"><label>Número Factura:</label><input type="text" id="numeroFactura" required></div>
                        <div class="form-group"><label>Monto:</label><input type="number" id="montoCobrar" step="0.01" required></div>
                        <div class="form-group"><label>Fecha Emisión:</label><input type="date" id="fechaEmisionCobrar" value="${new Date().toISOString().split('T')[0]}" required></div>
                        <div class="form-group"><label>Fecha Vencimiento:</label><input type="date" id="fechaVencimientoCobrar" required></div>
                        <div class="form-group"><label>Descripción:</label><textarea id="descripcionCobrar" rows="2"></textarea></div>
                        <button type="submit" class="btn-primary">Guardar</button>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            } catch (error) {
                console.error('Error cargando clientes:', error);
                mostrarToast('Error al cargar clientes', 'error');
            }
        };

        const guardarCuentaCobrar = async (event) => {
            event.preventDefault();
            const data = {
                clienteId: parseInt(document.getElementById('clienteCobrar').value),
                numeroFactura: document.getElementById('numeroFactura').value,
                monto: parseFloat(document.getElementById('montoCobrar').value),
                saldo: parseFloat(document.getElementById('montoCobrar').value),
                fechaEmision: document.getElementById('fechaEmisionCobrar').value,
                fechaVencimiento: document.getElementById('fechaVencimientoCobrar').value,
                descripcion: document.getElementById('descripcionCobrar').value,
                estado: 'pendiente',
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                await DB.add('cuentasPorCobrar', data);
                cerrarModal(); cargarCuentasCobrar(); actualizarWidgets();
                mostrarToast('Cuenta por cobrar guardada exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando cuenta:', error);
                mostrarToast('Error al guardar la cuenta', 'error');
            }
        };

        const cargarCuentasCobrar = async (filtro = 'todas') => {
            try {
                let cuentas = await DB.getAll('cuentasPorCobrar');
                
                if (filtro !== 'todas') {
                    const hoy = new Date();
                    cuentas = cuentas.filter(c => {
                        if (filtro === 'pendientes') return c.estado === 'pendiente' && new Date(c.fechaVencimiento) >= hoy;
                        if (filtro === 'vencidas') return c.estado === 'pendiente' && new Date(c.fechaVencimiento) < hoy;
                        if (filtro === 'pagadas') return c.estado === 'pagada';
                        return true;
                    });
                }
                
                const clientes = await DB.getAll('clientes');
                const tbody = document.getElementById('cuerpoTablaCuentasCobrar');
                tbody.innerHTML = '';
                cuentas.forEach(cuenta => {
                    const cliente = clientes.find(c => c.id === cuenta.clienteId);
                    const vencida = new Date(cuenta.fechaVencimiento) < new Date() && cuenta.estado !== 'pagada';
                    tbody.innerHTML += `
                        <tr style="${vencida ? 'background: rgba(255,82,82,0.1);' : ''}">
                            <td>${cuenta.id}</td>
                            <td>${cliente ? cliente.nombre : 'N/A'}</td>
                            <td>₡${cuenta.monto.toFixed(2)}</td>
                            <td>₡${cuenta.saldo.toFixed(2)}</td>
                            <td>${cuenta.fechaEmision}</td>
                            <td>${cuenta.fechaVencimiento}</td>
                            <td><span style="color: ${cuenta.estado === 'pagada' ? 'var(--color-exito)' : vencida ? 'var(--color-error)' : 'var(--color-accent)'};">${cuenta.estado}</span></td>
                            <td>
                                ${cuenta.estado !== 'pagada' ? `<button class="btn-secondary" onclick="registrarPagoCobrar(${cuenta.id})">Pagar</button>` : ''}
                                <button class="btn-error" onclick="eliminarCuentaCobrar(${cuenta.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando cuentas por cobrar:', error);
            }
        };

        const filtrarCuentasCobrar = (filtro) => cargarCuentasCobrar(filtro);

        const registrarPagoCobrar = async (id) => {
            try {
                const cuenta = await DB.get('cuentasPorCobrar', id);
                const formHTML = `
                    <h3>Registrar Pago</h3>
                    <p><strong>Saldo Pendiente:</strong> ₡${cuenta.saldo.toFixed(2)}</p>
                    <form id="formPagoCobrar" onsubmit="guardarPagoCobrar(event, ${id})">
                        <div class="form-group"><label>Monto a Pagar:</label><input type="number" id="montoPago" step="0.01" max="${cuenta.saldo}" value="${cuenta.saldo}" required></div>
                        <div class="form-group"><label>Fecha Pago:</label><input type="date" id="fechaPago" value="${new Date().toISOString().split('T')[0]}" required></div>
                        <div class="form-group"><label>Método:</label><select id="metodoPago"><option>Efectivo</option><option>Transferencia</option><option>Cheque</option><option>Tarjeta</option></select></div>
                        <button type="submit" class="btn-primary">Registrar Pago</button>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            } catch (error) {
                console.error('Error cargando cuenta:', error);
                mostrarToast('Error al cargar la cuenta', 'error');
            }
        };

        const guardarPagoCobrar = async (event, id) => {
            event.preventDefault();
            const monto = parseFloat(document.getElementById('montoPago').value);
            
            try {
                const cuenta = await DB.get('cuentasPorCobrar', id);
                cuenta.saldo -= monto;
                if (cuenta.saldo <= 0.01) {
                    cuenta.saldo = 0;
                    cuenta.estado = 'pagada';
                }
                await DB.put('cuentasPorCobrar', id, cuenta);
                cerrarModal(); cargarCuentasCobrar(); actualizarWidgets(); 
                mostrarToast('Pago registrado exitosamente', 'success');
            } catch (error) {
                console.error('Error registrando pago:', error);
                mostrarToast('Error al registrar el pago', 'error');
            }
        };

        const eliminarCuentaCobrar = (id) => {
            confirmarAccion(
                'Se eliminará esta cuenta por cobrar permanentemente.',
                async () => {
                    try {
                        await DB.delete('cuentasPorCobrar', id);
                        cargarCuentasCobrar(); 
                        actualizarWidgets();
                        mostrarToast('Cuenta por cobrar eliminada', 'success');
                    } catch (error) {
                        console.error('Error eliminando cuenta:', error);
                        mostrarToast('Error al eliminar la cuenta', 'error');
                    }
                },
                '¿Eliminar Cuenta?'
            );
        };
        const abrirFormularioCuentaPagar = async () => {
            try {
                const proveedores = await DB.getAll('proveedores');
                const options = proveedores.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
                const formHTML = `
                    <h3>Nueva Cuenta por Pagar</h3>
                    <form id="formCuentaPagar" onsubmit="guardarCuentaPagar(event)">
                        <div class="form-group"><label>Proveedor:</label><select id="proveedorPagar" required>${options}</select></div>
                        <div class="form-group"><label>Número Factura:</label><input type="text" id="numeroFacturaPagar" required></div>
                        <div class="form-group"><label>Monto:</label><input type="number" id="montoPagar" step="0.01" required></div>
                        <div class="form-group"><label>Fecha Emisión:</label><input type="date" id="fechaEmisionPagar" value="${new Date().toISOString().split('T')[0]}" required></div>
                        <div class="form-group"><label>Fecha Vencimiento:</label><input type="date" id="fechaVencimientoPagar" required></div>
                        <div class="form-group"><label>Descripción:</label><textarea id="descripcionPagar" rows="2"></textarea></div>
                        <button type="submit" class="btn-primary">Guardar</button>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            } catch (error) {
                console.error('Error cargando proveedores:', error);
                mostrarToast('Error al cargar proveedores', 'error');
            }
        };

        const guardarCuentaPagar = async (event) => {
            event.preventDefault();
            const data = {
                proveedorId: parseInt(document.getElementById('proveedorPagar').value),
                numeroFactura: document.getElementById('numeroFacturaPagar').value,
                monto: parseFloat(document.getElementById('montoPagar').value),
                saldo: parseFloat(document.getElementById('montoPagar').value),
                fechaEmision: document.getElementById('fechaEmisionPagar').value,
                fechaVencimiento: document.getElementById('fechaVencimientoPagar').value,
                descripcion: document.getElementById('descripcionPagar').value,
                estado: 'pendiente',
                fechaCreacion: new Date().toISOString()
            };
            
            try {
                await DB.add('cuentasPorPagar', data);
                cerrarModal(); cargarCuentasPagar(); actualizarWidgets();
                mostrarToast('Cuenta por pagar guardada exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando cuenta:', error);
                mostrarToast('Error al guardar la cuenta', 'error');
            }
        };

        const cargarCuentasPagar = async (filtro = 'todas') => {
            try {
                let cuentas = await DB.getAll('cuentasPorPagar');
                
                if (filtro !== 'todas') {
                    const hoy = new Date();
                    cuentas = cuentas.filter(c => {
                        if (filtro === 'pendientes') return c.estado === 'pendiente' && new Date(c.fechaVencimiento) >= hoy;
                        if (filtro === 'vencidas') return c.estado === 'pendiente' && new Date(c.fechaVencimiento) < hoy;
                        if (filtro === 'pagadas') return c.estado === 'pagada';
                        return true;
                    });
                }
                
                const proveedores = await DB.getAll('proveedores');
                const tbody = document.getElementById('cuerpoTablaCuentasPagar');
                tbody.innerHTML = '';
                cuentas.forEach(cuenta => {
                    const proveedor = proveedores.find(p => p.id === cuenta.proveedorId);
                    const vencida = new Date(cuenta.fechaVencimiento) < new Date() && cuenta.estado !== 'pagada';
                    tbody.innerHTML += `
                        <tr style="${vencida ? 'background: rgba(255,82,82,0.1);' : ''}">
                            <td>${cuenta.id}</td>
                            <td>${proveedor ? proveedor.nombre : 'N/A'}</td>
                            <td>₡${cuenta.monto.toFixed(2)}</td>
                            <td>₡${cuenta.saldo.toFixed(2)}</td>
                            <td>${cuenta.fechaEmision}</td>
                            <td>${cuenta.fechaVencimiento}</td>
                            <td><span style="color: ${cuenta.estado === 'pagada' ? 'var(--color-exito)' : vencida ? 'var(--color-error)' : 'var(--color-accent)'};">${cuenta.estado}</span></td>
                            <td>
                                ${cuenta.estado !== 'pagada' ? `<button class="btn-secondary" onclick="registrarPagoPagar(${cuenta.id})">Pagar</button>` : ''}
                                <button class="btn-error" onclick="eliminarCuentaPagar(${cuenta.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando cuentas por pagar:', error);
            }
        };

        const filtrarCuentasPagar = (filtro) => cargarCuentasPagar(filtro);

        const registrarPagoPagar = async (id) => {
            try {
                const cuenta = await DB.get('cuentasPorPagar', id);
                const formHTML = `
                    <h3>Registrar Pago</h3>
                    <p><strong>Saldo Pendiente:</strong> ₡${cuenta.saldo.toFixed(2)}</p>
                    <form id="formPagoPagar" onsubmit="guardarPagoPagar(event, ${id})">
                        <div class="form-group"><label>Monto a Pagar:</label><input type="number" id="montoPagoPagar" step="0.01" max="${cuenta.saldo}" value="${cuenta.saldo}" required></div>
                        <div class="form-group"><label>Fecha Pago:</label><input type="date" id="fechaPagoPagar" value="${new Date().toISOString().split('T')[0]}" required></div>
                        <div class="form-group"><label>Método:</label><select id="metodoPagoPagar"><option>Efectivo</option><option>Transferencia</option><option>Cheque</option><option>Tarjeta</option></select></div>
                        <button type="submit" class="btn-primary">Registrar Pago</button>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            } catch (error) {
                console.error('Error cargando cuenta:', error);
                mostrarToast('Error al cargar la cuenta', 'error');
            }
        };

        const guardarPagoPagar = async (event, id) => {
            event.preventDefault();
            const monto = parseFloat(document.getElementById('montoPagoPagar').value);
            
            try {
                const cuenta = await DB.get('cuentasPorPagar', id);
                cuenta.saldo -= monto;
                if (cuenta.saldo <= 0.01) {
                    cuenta.saldo = 0;
                    cuenta.estado = 'pagada';
                }
                await DB.put('cuentasPorPagar', id, cuenta);
                cerrarModal(); cargarCuentasPagar(); actualizarWidgets(); 
                mostrarToast('Pago registrado exitosamente', 'success');
            } catch (error) {
                console.error('Error registrando pago:', error);
                mostrarToast('Error al registrar el pago', 'error');
            }
        };

        const eliminarCuentaPagar = (id) => {
            confirmarAccion(
                'Se eliminará esta cuenta por pagar permanentemente.',
                async () => {
                    try {
                        await DB.delete('cuentasPorPagar', id);
                        cargarCuentasPagar(); 
                        actualizarWidgets();
                        mostrarToast('Cuenta por pagar eliminada', 'success');
                    } catch (error) {
                        console.error('Error eliminando cuenta:', error);
                        mostrarToast('Error al eliminar la cuenta', 'error');
                    }
                },
                '¿Eliminar Cuenta?'
            );
        };
        const abrirFormularioActivo = () => {
            const formHTML = `
                <h3>Nuevo Activo Fijo</h3>
                <form id="formActivo" onsubmit="guardarActivo(event)">
                    <div class="form-group"><label>Descripción:</label><input type="text" id="descripcionActivo" required></div>
                    <div class="form-group"><label>Categoría:</label><select id="categoriaActivo"><option>Terrenos</option><option>Edificios</option><option>Mobiliario</option><option>Equipo de Cómputo</option><option>Vehículos</option><option>Maquinaria</option></select></div>
                    <div class="form-group"><label>Valor de Compra:</label><input type="number" id="valorCompra" step="0.01" required></div>
                    <div class="form-group"><label>Valor Residual:</label><input type="number" id="valorResidualActivo" step="0.01" value="0"></div>
                    <div class="form-group"><label>Vida Útil (años):</label><input type="number" id="vidaUtilActivo" min="1" required></div>
                    <div class="form-group"><label>Fecha de Compra:</label><input type="date" id="fechaCompra" value="${new Date().toISOString().split('T')[0]}" required></div>
                    <div class="form-group"><label>Proveedor:</label><input type="text" id="proveedorActivo"></div>
                    <button type="submit" class="btn-primary">Guardar</button>
                </form>
            `;
            abrirModalConContenido(formHTML);
        };

        const guardarActivo = async (event) => {
            event.preventDefault();
            const valorCompra = parseFloat(document.getElementById('valorCompra').value);
            const valorResidual = parseFloat(document.getElementById('valorResidualActivo').value);
            const vidaUtil = parseInt(document.getElementById('vidaUtilActivo').value);
            
            const data = {
                descripcion: document.getElementById('descripcionActivo').value,
                categoria: document.getElementById('categoriaActivo').value,
                valorCompra: valorCompra,
                valorResidual: valorResidual,
                vidaUtil: vidaUtil,
                depreciacionAnual: (valorCompra - valorResidual) / vidaUtil,
                depreciacionAcumulada: 0,
                valorEnLibros: valorCompra,
                fechaCompra: document.getElementById('fechaCompra').value,
                proveedor: document.getElementById('proveedorActivo').value,
                estado: 'activo',
                fechaRegistro: new Date().toISOString()
            };
            
            try {
                await DB.add('activos', data);
                cerrarModal(); cargarActivos(); actualizarWidgets();
                mostrarToast('Activo guardado exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando activo:', error);
                mostrarToast('Error al guardar el activo', 'error');
            }
        };

        const cargarActivos = async () => {
            try {
                const activos = await DB.getAll('activos');
                const tbody = document.getElementById('cuerpoTablaActivos');
                tbody.innerHTML = '';
                activos.forEach(activo => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${activo.id}</td>
                            <td>${activo.descripcion}</td>
                            <td>${activo.categoria}</td>
                            <td>₡${activo.valorCompra.toFixed(2)}</td>
                            <td>₡${activo.depreciacionAcumulada.toFixed(2)}</td>
                            <td>₡${activo.valorEnLibros.toFixed(2)}</td>
                            <td>${activo.fechaCompra}</td>
                            <td>
                                <button class="btn-info" onclick="verDetalleActivo(${activo.id})" title="Ver Detalle"><i class="fas fa-eye"></i></button>
                                <button class="btn-secondary" onclick="editarActivo(${activo.id})" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn-secondary" onclick="calcularDepreciacionActivo(${activo.id})" title="Depreciar"><i class="fas fa-calculator"></i></button>
                                <button class="btn-error" onclick="eliminarActivo(${activo.id})" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando activos:', error);
            }
        };
        
        const editarActivo = async (id) => {
            try {
                const activo = await DB.get('activos', id);
                const formHTML = `
                    <h3 style="color: var(--color-dorado); margin-bottom: 1.5rem;">
                        <i class="fas fa-edit"></i> Editar Activo Fijo
                    </h3>
                    <form id="formEditarActivo" onsubmit="actualizarActivo(event, ${id})">
                        <div style="background: rgba(255,215,0,0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> Descripción *</label>
                                <input type="text" id="descripcionActivo" value="${activo.descripcion}" required>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-folder"></i> Categoría *</label>
                                <select id="categoriaActivo" required>
                                    <option value="Terrenos" ${activo.categoria === 'Terrenos' ? 'selected' : ''}>Terrenos</option>
                                    <option value="Edificios" ${activo.categoria === 'Edificios' ? 'selected' : ''}>Edificios</option>
                                    <option value="Mobiliario" ${activo.categoria === 'Mobiliario' ? 'selected' : ''}>Mobiliario</option>
                                    <option value="Equipo de Cómputo" ${activo.categoria === 'Equipo de Cómputo' ? 'selected' : ''}>Equipo de Cómputo</option>
                                    <option value="Vehículos" ${activo.categoria === 'Vehículos' ? 'selected' : ''}>Vehículos</option>
                                    <option value="Maquinaria" ${activo.categoria === 'Maquinaria' ? 'selected' : ''}>Maquinaria</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-user"></i> Proveedor</label>
                                <input type="text" id="proveedorActivo" value="${activo.proveedor || ''}">
                            </div>
                        </div>
                        
                        <div style="background: rgba(76,175,80,0.1); padding: 1rem; border-left: 4px solid var(--color-exito); border-radius: 4px; margin-bottom: 1rem;">
                            <p style="margin: 0.25rem 0;"><strong>Valor de Compra:</strong> ₡${activo.valorCompra.toFixed(2)} <small>(No editable)</small></p>
                            <p style="margin: 0.25rem 0;"><strong>Valor Residual:</strong> ₡${activo.valorResidual.toFixed(2)} <small>(No editable)</small></p>
                            <p style="margin: 0.25rem 0;"><strong>Vida Útil:</strong> ${activo.vidaUtil} años <small>(No editable)</small></p>
                            <p style="margin: 0.25rem 0;"><strong>Depreciación Anual:</strong> ₡${activo.depreciacionAnual.toFixed(2)}</p>
                            <p style="margin: 0.25rem 0;"><strong>Depreciación Acumulada:</strong> ₡${activo.depreciacionAcumulada.toFixed(2)}</p>
                            <p style="margin: 0.25rem 0;"><strong>Valor en Libros:</strong> ₡${activo.valorEnLibros.toFixed(2)}</p>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn-secondary" onclick="cerrarModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> Actualizar
                            </button>
                        </div>
                    </form>
                `;
                abrirModalConContenido(formHTML);
            } catch (error) {
                console.error('Error cargando activo:', error);
                mostrarToast('Error al cargar activo', 'error');
            }
        };
        
        const actualizarActivo = async (event, id) => {
            event.preventDefault();
            try {
                const activo = await DB.get('activos', id);
                activo.descripcion = document.getElementById('descripcionActivo').value;
                activo.categoria = document.getElementById('categoriaActivo').value;
                activo.proveedor = document.getElementById('proveedorActivo').value;
                
                await DB.put('activos', id, activo);
                cerrarModal();
                cargarActivos();
                mostrarToast('Activo actualizado exitosamente', 'success');
            } catch (error) {
                console.error('Error actualizando activo:', error);
                mostrarToast('Error al actualizar activo', 'error');
            }
        };
        
        const verDetalleActivo = async (id) => {
            try {
                const activo = await DB.get('activos', id);
                const añosDepreciados = Math.floor(activo.depreciacionAcumulada / activo.depreciacionAnual);
                const porcentajeDepreciado = ((activo.depreciacionAcumulada / (activo.valorCompra - activo.valorResidual)) * 100).toFixed(2);
                const añosRestantes = activo.vidaUtil - añosDepreciados;
                
                const html = `
                    <div style="padding: 2rem;">
                        <h3 style="color: var(--color-dorado); margin-bottom: 1.5rem; text-align: center;">
                            <i class="fas fa-building"></i> Detalle del Activo Fijo
                        </h3>
                        
                        <div style="background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05)); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(255,215,0,0.3);">
                            <h4 style="color: var(--color-dorado); margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Información General</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <p><strong>ID:</strong> ${activo.id}</p>
                                <p><strong>Categoría:</strong> ${activo.categoria}</p>
                                <p><strong>Descripción:</strong> ${activo.descripcion}</p>
                                <p><strong>Proveedor:</strong> ${activo.proveedor || 'N/A'}</p>
                                <p><strong>Fecha de Compra:</strong> ${new Date(activo.fechaCompra).toLocaleDateString('es-ES')}</p>
                                <p><strong>Estado:</strong> <span style="color: var(--color-exito);">${activo.estado}</span></p>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(145deg, rgba(76,175,80,0.1), rgba(76,175,80,0.05)); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(76,175,80,0.3);">
                            <h4 style="color: var(--color-exito); margin-bottom: 1rem;"><i class="fas fa-dollar-sign"></i> Valores Financieros</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                                    <p style="opacity: 0.8; margin-bottom: 0.5rem;">Valor de Compra</p>
                                    <p style="font-size: 1.5rem; font-weight: bold; color: var(--color-dorado);">₡${activo.valorCompra.toFixed(2)}</p>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                                    <p style="opacity: 0.8; margin-bottom: 0.5rem;">Valor Residual</p>
                                    <p style="font-size: 1.5rem; font-weight: bold; color: var(--color-platino);">₡${activo.valorResidual.toFixed(2)}</p>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                                    <p style="opacity: 0.8; margin-bottom: 0.5rem;">Depreciación Acumulada</p>
                                    <p style="font-size: 1.5rem; font-weight: bold; color: var(--color-error);">₡${activo.depreciacionAcumulada.toFixed(2)}</p>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                                    <p style="opacity: 0.8; margin-bottom: 0.5rem;">Valor en Libros</p>
                                    <p style="font-size: 1.5rem; font-weight: bold; color: var(--color-exito);">₡${activo.valorEnLibros.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(145deg, rgba(243,156,18,0.1), rgba(243,156,18,0.05)); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(243,156,18,0.3);">
                            <h4 style="color: #f39c12; margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> Análisis de Depreciación</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <p style="opacity: 0.8;">Depreciación Anual</p>
                                    <p style="font-size: 1.2rem; font-weight: bold;">₡${activo.depreciacionAnual.toFixed(2)}</p>
                                </div>
                                <div>
                                    <p style="opacity: 0.8;">Vida Útil Total</p>
                                    <p style="font-size: 1.2rem; font-weight: bold;">${activo.vidaUtil} años</p>
                                </div>
                                <div>
                                    <p style="opacity: 0.8;">Años Depreciados</p>
                                    <p style="font-size: 1.2rem; font-weight: bold;">${añosDepreciados} años</p>
                                </div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <p style="opacity: 0.8; margin-bottom: 0.5rem;">Progreso de Depreciación</p>
                                <div style="background: rgba(0,0,0,0.3); height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                                    <div style="background: linear-gradient(90deg, #f39c12, #e67e22); height: 100%; width: ${porcentajeDepreciado}%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9rem;">
                                        ${porcentajeDepreciado}%
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div>
                                    <p style="opacity: 0.8;">Años Restantes</p>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: ${añosRestantes > 0 ? 'var(--color-exito)' : 'var(--color-error)'};">${añosRestantes > 0 ? añosRestantes + ' años' : 'Totalmente depreciado'}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="opacity: 0.8;">Depreciación Mensual</p>
                                    <p style="font-size: 1.2rem; font-weight: bold;">₡${(activo.depreciacionAnual / 12).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                            <button class="btn-secondary" onclick="editarActivo(${activo.id})">
                                <i class="fas fa-edit"></i> Editar Activo
                            </button>
                            <button class="btn-secondary" onclick="calcularDepreciacionActivo(${activo.id})">
                                <i class="fas fa-calculator"></i> Calcular Depreciación
                            </button>
                            <button class="btn-primary" onclick="cerrarModal()">
                                <i class="fas fa-check"></i> Cerrar
                            </button>
                        </div>
                    </div>
                `;
                abrirModalConContenido(html);
            } catch (error) {
                console.error('Error mostrando detalle activo:', error);
                mostrarToast('Error al cargar detalle', 'error');
            }
        };

        const calcularDepreciacionActivo = async (id) => {
            try {
                const activo = await DB.get('activos', id);
                activo.depreciacionAcumulada += activo.depreciacionAnual;
                activo.valorEnLibros = activo.valorCompra - activo.depreciacionAcumulada;
                
                if (activo.valorEnLibros < activo.valorResidual) {
                    activo.valorEnLibros = activo.valorResidual;
                    activo.depreciacionAcumulada = activo.valorCompra - activo.valorResidual;
                }
                
                await DB.put('activos', id, activo);
                cargarActivos();
                mostrarToast('Depreciación calculada correctamente', 'success');
            } catch (error) {
                console.error('Error calculando depreciación:', error);
                mostrarToast('Error al calcular depreciación', 'error');
            }
        };

        const eliminarActivo = (id) => {
            confirmarAccion(
                'Se eliminará este activo fijo y su historial de depreciación.',
                async () => {
                    try {
                        await DB.delete('activos', id);
                        cargarActivos(); 
                        actualizarWidgets();
                        mostrarToast('Activo eliminado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando activo:', error);
                        mostrarToast('Error al eliminar el activo', 'error');
                    }
                },
                '¿Eliminar Activo?'
            );
        };

        const buscarActivos = async () => {
            try {
                const termino = document.getElementById('buscarActivo').value.toLowerCase();
                const activos = await DB.getAll('activos');
                const filtrados = activos.filter(a => 
                    a.descripcion.toLowerCase().includes(termino) || 
                    a.categoria.toLowerCase().includes(termino)
                );
                const tbody = document.getElementById('cuerpoTablaActivos');
                tbody.innerHTML = '';
                filtrados.forEach(activo => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${activo.id}</td>
                            <td>${activo.descripcion}</td>
                            <td>${activo.categoria}</td>
                            <td>₡${activo.valorCompra.toFixed(2)}</td>
                            <td>₡${activo.depreciacionAcumulada.toFixed(2)}</td>
                            <td>₡${activo.valorEnLibros.toFixed(2)}</td>
                            <td>${activo.fechaCompra}</td>
                            <td>
                                <button class="btn-secondary" onclick="calcularDepreciacionActivo(${activo.id})">Depreciar</button>
                                <button class="btn-error" onclick="eliminarActivo(${activo.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error buscando activos:', error);
            }
        };
        let bancoSeleccionado = null;
        const abrirFormularioBanco = () => {
            const formHTML = `
                <h3>Nueva Cuenta Bancaria</h3>
                <form id="formBanco" onsubmit="guardarBanco(event)">
                    <div class="form-group"><label>Nombre del Banco:</label><input type="text" id="nombreBanco" required></div>
                    <div class="form-group"><label>Número de Cuenta:</label><input type="text" id="numeroCuenta" required></div>
                    <div class="form-group"><label>Tipo de Cuenta:</label><select id="tipoCuenta"><option>Corriente</option><option>Ahorros</option><option>Inversión</option></select></div>
                    <div class="form-group"><label>Saldo Inicial:</label><input type="number" id="saldoInicial" step="0.01" value="0" required></div>
                    <button type="submit" class="btn-primary">Guardar</button>
                </form>
            `;
            abrirModalConContenido(formHTML);
        };

        const guardarBanco = async (event) => {
            event.preventDefault();
            const data = {
                nombre: document.getElementById('nombreBanco').value,
                numeroCuenta: document.getElementById('numeroCuenta').value,
                tipo: document.getElementById('tipoCuenta').value,
                saldo: parseFloat(document.getElementById('saldoInicial').value),
                fechaApertura: new Date().toISOString()
            };
            
            try {
                await DB.add('bancos', data);
                cerrarModal(); cargarBancos(); actualizarWidgets();
                mostrarToast('Banco guardado exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando banco:', error);
                mostrarToast('Error al guardar el banco', 'error');
            }
        };

        const cargarBancos = async () => {
            try {
                const bancos = await DB.getAll('bancos');
                const tbody = document.getElementById('cuerpoTablaBancos');
                tbody.innerHTML = '';
                bancos.forEach(banco => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${banco.id}</td>
                            <td>${banco.nombre}</td>
                            <td>${banco.numeroCuenta}</td>
                            <td>${banco.tipo}</td>
                            <td>₡${banco.saldo.toFixed(2)}</td>
                            <td>
                                <button class="btn-secondary" onclick="verMovimientos(${banco.id})">Movimientos</button>
                                <button class="btn-error" onclick="eliminarBanco(${banco.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando bancos:', error);
            }
        };

        const verMovimientos = (bancoId) => {
            bancoSeleccionado = bancoId;
            document.getElementById('movimientosBancarios').style.display = 'block';
            cargarMovimientos(bancoId);
        };

        const cargarMovimientos = async (bancoId) => {
            try {
                const movimientos = await DB.getAll('movimientosBancarios');
                const movimientosFiltrados = movimientos.filter(m => m.bancoId === bancoId);
                const tbody = document.getElementById('cuerpoTablaMovimientos');
                tbody.innerHTML = '';
                movimientosFiltrados.forEach(mov => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${mov.fecha}</td>
                            <td>${mov.tipo}</td>
                            <td>${mov.descripcion}</td>
                            <td style="color: ${mov.tipo === 'ingreso' ? 'var(--color-exito)' : 'var(--color-error)'};">₡${mov.monto.toFixed(2)}</td>
                            <td>₡${mov.saldoResultante.toFixed(2)}</td>
                            <td><button class="btn-error" onclick="eliminarMovimiento(${mov.id})">Eliminar</button></td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.warn('Error cargando movimientos:', error);
            }
        };

        const abrirFormularioMovimiento = () => {
            if (!bancoSeleccionado) {
                mostrarToast('Selecciona un banco primero', 'warning');
                return;
            }
            
            const formHTML = `
                <h3>Nuevo Movimiento Bancario</h3>
                <form id="formMovimiento" onsubmit="guardarMovimiento(event)">
                    <div class="form-group"><label>Tipo:</label><select id="tipoMovimiento"><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select></div>
                    <div class="form-group"><label>Monto:</label><input type="number" id="montoMovimiento" step="0.01" required></div>
                    <div class="form-group"><label>Fecha:</label><input type="date" id="fechaMovimiento" value="${new Date().toISOString().split('T')[0]}" required></div>
                    <div class="form-group"><label>Descripción:</label><textarea id="descripcionMovimiento" rows="2" required></textarea></div>
                    <button type="submit" class="btn-primary">Guardar</button>
                </form>
            `;
            abrirModalConContenido(formHTML);
        };

        const guardarMovimiento = async (event) => {
            event.preventDefault();
            const tipo = document.getElementById('tipoMovimiento').value;
            const monto = parseFloat(document.getElementById('montoMovimiento').value);
            
            try {
                const banco = await DB.get('bancos', bancoSeleccionado);
                const nuevoSaldo = tipo === 'ingreso' ? banco.saldo + monto : banco.saldo - monto;
                
                banco.saldo = nuevoSaldo;
                await DB.put('bancos', bancoSeleccionado, banco);
                
                await DB.add('movimientosBancarios', {
                    bancoId: bancoSeleccionado,
                    tipo: tipo,
                    monto: monto,
                    descripcion: document.getElementById('descripcionMovimiento').value,
                    fecha: document.getElementById('fechaMovimiento').value,
                    saldoResultante: nuevoSaldo,
                    fechaRegistro: new Date().toISOString()
                });
                
                cerrarModal(); cargarBancos(); cargarMovimientos(bancoSeleccionado); actualizarWidgets();
                mostrarToast('Movimiento guardado exitosamente', 'success');
            } catch (error) {
                console.error('Error guardando movimiento:', error);
                mostrarToast('Error al guardar el movimiento', 'error');
            }
        };

        const eliminarBanco = (id) => {
            confirmarAccion(
                'Se eliminará esta cuenta bancaria y todos sus movimientos.',
                async () => {
                    try {
                        await DB.delete('bancos', id);
                        cargarBancos(); 
                        actualizarWidgets();
                        mostrarToast('Cuenta bancaria eliminada', 'success');
                    } catch (error) {
                        console.error('Error eliminando banco:', error);
                        mostrarToast('Error al eliminar el banco', 'error');
                    }
                },
                '¿Eliminar Cuenta Bancaria?'
            );
        };

        const eliminarMovimiento = (id) => {
            confirmarAccion(
                'Se eliminará este movimiento bancario.',
                async () => {
                    try {
                        await DB.delete('movimientosBancarios', id);
                        cargarMovimientos(bancoSeleccionado);
                        mostrarToast('Movimiento eliminado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando movimiento:', error);
                        mostrarToast('Error al eliminar el movimiento', 'error');
                    }
                },
                '¿Eliminar Movimiento?'
            );
        };

        
        // ===== ALERTA PERSONALIZADA =====
        function mostrarAlertaAccesoDenegado(modulo){const o=document.createElement('div');o.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999999;display:flex;align-items:center;justify-content:center';const m=document.createElement('div');m.style.cssText='background:linear-gradient(145deg,#1a1a1a,#2a2a2a);border:3px solid #dc2626;border-radius:20px;padding:3rem;max-width:500px;text-align:center;box-shadow:0 20px 60px rgba(220,38,38,0.5)';m.innerHTML=`<div style="width:100px;height:100px;margin:0 auto 1.5rem;background:linear-gradient(135deg,#dc2626,#991b1b);border-radius:50%;display:flex;align-items:center;justify-content:center"><i class="fas fa-shield-alt" style="font-size:3rem;color:white"></i></div><h2 style="color:#dc2626;font-size:2rem;margin-bottom:1rem;font-weight:700">⛔ Acceso Denegado</h2><p style="color:#E5E4E2;font-size:1.1rem;margin-bottom:1.5rem">No tienes permisos para:<br><strong style="color:#FFD700;font-size:1.3rem">${modulo}</strong></p><button onclick="window.location.href='homeajhb.html'" style="background:linear-gradient(135deg,#FFD700,#FFC107);color:#0a0a0a;border:none;padding:1rem 2.5rem;border-radius:12px;font-size:1.1rem;font-weight:700;cursor:pointer"><i class="fas fa-home"></i> Volver</button>`;o.appendChild(m);document.body.appendChild(o);}
        
        // ===== PROTECCIÓN DE AUTENTICACIÓN =====
        (async function verificarAcceso() {
            const token = localStorage.getItem('ajhb_token');
            const userData = localStorage.getItem('ajhb_user');
            
            if (!token || !userData) {
                console.log('❌ Acceso denegado: No hay sesión activa');
                window.location.href = 'login1.html';
                return;
            }
            
            try {
                const user = JSON.parse(userData);
                const permisos = user.permisos ? user.permisos.split(',') : [];
                
                // Verificar si tiene permiso para contaduría
                if (user.role !== 'director' && !permisos.includes('contaduria')) {
                    console.log('❌ Acceso denegado: Sin permisos para Contaduría');
                    mostrarAlertaAccesoDenegado('Departamento de Contaduría');
                    return;
                }
                
                // Verificar token con backend
                const response = await fetch('http://localhost:5003/api/verify', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok || !(await response.json()).valid) {
                    console.log('❌ Token inválido');
                    localStorage.removeItem('ajhb_token');
                    localStorage.removeItem('ajhb_user');
                    window.location.href = 'login1.html';
                    return;
                }
                
                console.log('✅ Acceso autorizado a Contaduría');
            } catch (error) {
                console.error('❌ Error al verificar acceso:', error);
                window.location.href = 'login1.html';
            }
        })();
    </script>
</body>
</html>